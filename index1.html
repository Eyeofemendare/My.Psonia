<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Λίστα Αγορών — Κοινή (PWA)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#4f46e5">
  <style>
    :root { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { background: #f7f7fb; color: #111827; min-height:100vh; -webkit-font-smoothing:antialiased; }
    .card { box-shadow: 0 10px 20px rgba(17,24,39,0.06); }
    .list-item { transition: background-color .12s, transform .06s; }
    .list-item:active { transform: scale(.998); }
    .completed { text-decoration: line-through; color:#9CA3AF; }
    .small-muted { font-size: .85rem; color:#6b7280; }
    .priority-3 { border-left: 4px solid #dc2626; } /* πολύ επείγον - red */
    .priority-2 { border-left: 4px solid #f59e0b; } /* επείγον - amber */
    .priority-1 { border-left: 4px solid #10b981; } /* όταν μπορέσεις - green */
    .dark-mode { background: #0b1220; color: #e6eef8; }
    .dark-mode .card { background: #071024; box-shadow: none; }
    .dark-mode input, .dark-mode textarea { background: #071224; color: #e6eef8; border-color: #1f2937; }
    .thumb { width:48px; height:48px; object-fit:cover; border-radius:6px; cursor:pointer; }
    .modal-backdrop { background: rgba(2,6,23,0.6); }
    .small-desc { font-size: .9rem; color: #6b7280; }
    .dark-mode .small-desc { color: #9fb2d4; }
  </style>
</head>
<body class="antialiased">

  <main class="max-w-4xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-1">Λίστα Αγορών</h1>
        <div class="small-muted">Κοινή λίστα για εσένα και τη σύζυγό σου — όλα συγχρονίζονται σε πραγματικό χρόνο.</div>
      </div>

      <div class="flex items-center gap-3">
        <button id="toggleTheme" class="px-3 py-2 bg-gray-100 rounded-md">Σκοτεινό/Φωτεινό</button>
      </div>
    </header>

    <!-- Lists management -->
    <section class="mb-4 flex flex-col md:flex-row gap-3 items-start">
      <div class="bg-white p-4 rounded-xl card w-full md:w-2/3">
        <div class="flex flex-col md:flex-row items-center gap-3">
          <label class="text-sm small-muted">Επιλογή Λίστας:</label>
          <select id="listSelect" class="p-2 border border-gray-200 rounded-md flex-1"></select>

          <div class="flex gap-2">
            <button id="addListBtn" class="bg-indigo-600 text-white px-3 py-2 rounded-md">Προσθήκη Λίστας</button>
            <button id="editListBtn" class="bg-yellow-500 text-white px-3 py-2 rounded-md">Επεξεργασία</button>
            <button id="removeListBtn" class="bg-red-500 text-white px-3 py-2 rounded-md">Διαγραφή</button>
          </div>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl card w-full md:w-1/3">
        <div class="text-sm small-muted mb-2">Ο χρήστης:</div>
        <div class="flex gap-2 items-center">
          <input id="display-name" placeholder="Όνομα (μπορεί να αλλάξει)" class="p-2 border border-gray-200 rounded-md flex-1" />
          <button id="save-name" class="bg-indigo-600 text-white px-3 py-2 rounded-md">Αποθήκευση</button>
        </div>
        <div id="userIdDisplay" class="text-xs small-muted mt-2"></div>
      </div>
    </section>

    <!-- Add item button and filters -->
    <section class="mb-4 flex flex-col md:flex-row gap-3 items-center">
      <div class="flex gap-3">
        <button id="openAddModal" class="bg-indigo-600 text-white px-4 py-3 rounded-lg shadow">Προσθήκη αντικειμένου</button>
        <button id="filterShowAll" class="px-3 py-2 border rounded">Όλα</button>
        <button id="filterShowPending" class="px-3 py-2 border rounded">Μη ολοκληρωμένα</button>
      </div>
      <div class="ml-auto small-muted text-right">
        Σειρά: <span class="font-medium">Πολύ επείγον → Επείγον → Όταν μπορέσεις</span>
      </div>
    </section>

    <!-- Shopping list -->
    <section class="bg-white rounded-xl card overflow-hidden p-2">
      <ul id="shoppingList" class="divide-y divide-gray-100">
        <!-- list items -->
      </ul>
      <div id="emptyState" class="p-6 text-center text-gray-500 hidden">
        Η λίστα είναι άδεια — πρόσθεσε ένα προϊόν!
      </div>
    </section>

    <div class="mt-5 flex justify-between items-center">
      <div>
        <button id="clearDoneBtn" class="bg-red-500 text-white px-4 py-2 rounded-md">Εκκαθάριση Ολοκληρωμένων</button>
      </div>
      <div class="small-muted">Οι εικόνες αποθηκεύονται ως μικρογραφίες (base64) στο έγγραφο - αν θες, μπορούμε να μεταβάλουμε σε Firebase Storage.</div>
    </div>
  </main>

  <!-- Add/Edit Item Modal -->
  <div id="itemModal" class="hidden fixed inset-0 z-40 flex items-center justify-center modal-backdrop">
    <div class="bg-white rounded-xl w-full max-w-2xl p-6 card relative">
      <button id="closeItemModal" class="absolute top-3 right-3 text-gray-600">✕</button>
      <h2 id="modalTitle" class="text-xl font-semibold mb-3">Προσθήκη προϊόντος</h2>

      <div class="grid grid-cols-1 gap-3">
        <label>Όνομα προϊόντος</label>
        <input id="itemName" class="p-2 border rounded-md w-full" placeholder="π.χ. Γάλα 1L" />

        <label>Περιγραφή (εμφανίζεται κάτω από το προϊόν)</label>
        <textarea id="itemDescription" rows="3" class="p-2 border rounded-md w-full" placeholder="Περιγραφή..."></textarea>

        <label>Σημειώσεις</label>
        <textarea id="itemNotes" rows="2" class="p-2 border rounded-md w-full" placeholder="Σημειώσεις / υπενθύμιση..."></textarea>

        <label>Επιλογή λιστών (μπορείς να επιλέξεις περισσότερες από 1)</label>
        <div id="listsCheckboxes" class="flex flex-wrap gap-2"></div>

        <label>Προτεραιότητα</label>
        <select id="itemPriority" class="p-2 border rounded-md w-full">
          <option value="1">Όταν μπορέσεις</option>
          <option value="2">Επείγον</option>
          <option value="3">Πολύ επείγον</option>
        </select>

        <label>Φωτογραφία (προαιρετικά)</label>
        <input id="itemImageInput" type="file" accept="image/*" class="p-2" />
        <div id="imagePreview" class="mt-2"></div>

        <div class="flex justify-end gap-3 mt-4">
          <button id="saveItemBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md">Αποθήκευση</button>
          <button id="cancelItemBtn" class="px-4 py-2 border rounded-md">Άκυρο</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Item Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white rounded-xl w-full max-w-lg p-6 card relative">
      <button id="closeDetailModal" class="absolute top-3 right-3 text-gray-600">✕</button>
      <div id="detailImageWrap" class="mb-4 text-center"></div>
      <h3 id="detailName" class="text-2xl font-bold mb-2"></h3>
      <div id="detailMeta" class="small-muted mb-3"></div>
      <div id="detailDescription" class="mb-3 small-desc"></div>
      <div id="detailNotes" class="mb-4 small-desc"></div>
      <div class="flex gap-3 justify-end">
        <button id="editItemBtn" class="bg-yellow-500 px-4 py-2 rounded-md text-white">Επεξεργασία</button>
        <button id="deleteItemBtn" class="bg-red-500 px-4 py-2 rounded-md text-white">Διαγραφή</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit List Modal -->
  <div id="listModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white rounded-xl w-full max-w-md p-6 card relative">
      <button id="closeListModal" class="absolute top-3 right-3 text-gray-600">✕</button>
      <h3 id="listModalTitle" class="text-xl font-semibold mb-3">Νέα λίστα</h3>
      <label>Όνομα λίστας</label>
      <input id="listNameInput" class="p-2 border rounded-md w-full mb-3" />
      <div class="flex justify-end gap-3">
        <button id="saveListBtn" class="bg-indigo-600 px-4 py-2 rounded-md text-white">Αποθήκευση</button>
        <button id="cancelListBtn" class="px-4 py-2 border rounded-md">Άκυρο</button>
      </div>
    </div>
  </div>

  <!-- Image preview modal (for enlarging thumbnails) -->
  <div id="imageModal" class="hidden fixed inset-0 z-60 flex items-center justify-center modal-backdrop">
    <div class="bg-transparent relative">
      <button id="closeImageModal" class="absolute -top-10 right-0 text-white text-2xl">✕</button>
      <img id="imageModalImg" src="" alt="Φωτογραφία" class="max-w-screen-md max-h-screen rounded-md shadow-lg" />
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  /*************************************************************************
   * Firebase config (user-provided) - already given
   *************************************************************************/
  const firebaseConfig = {
    apiKey: "AIzaSyAa9lz_EqEWx0OTfvVdIgmenNrDRy9nbTI",
    authDomain: "my-psonia.firebaseapp.com",
    projectId: "my-psonia",
    storageBucket: "my-psonia.firebasestorage.app",
    messagingSenderId: "557076927667",
    appId: "1:557076927667:web:0a09e333d63497b8460cc6",
    measurementId: "G-1S6RYCVRZ8"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Collections:
  // - 'lists' (documents: each list doc contains { name, createdAt })
  // - each list doc has subcollection 'items' with fields:
  //    { text, description, notes, priority (1..3), ownerId, ownerName, lists: [listIds], image (base64 string or null), done (bool), createdAt, completedAt }
  const listsCol = db.collection('lists');

  // DOM refs
  const listSelect = document.getElementById('listSelect');
  const addListBtn = document.getElementById('addListBtn');
  const editListBtn = document.getElementById('editListBtn');
  const removeListBtn = document.getElementById('removeListBtn');
  const listModal = document.getElementById('listModal');
  const listModalTitle = document.getElementById('listModalTitle');
  const listNameInput = document.getElementById('listNameInput');
  const saveListBtn = document.getElementById('saveListBtn');
  const cancelListBtn = document.getElementById('cancelListBtn');
  const closeListModal = document.getElementById('closeListModal');

  const openAddModal = document.getElementById('openAddModal');
  const itemModal = document.getElementById('itemModal');
  const closeItemModal = document.getElementById('closeItemModal');
  const modalTitle = document.getElementById('modalTitle');
  const itemName = document.getElementById('itemName');
  const itemDescription = document.getElementById('itemDescription');
  const itemNotes = document.getElementById('itemNotes');
  const listsCheckboxes = document.getElementById('listsCheckboxes');
  const itemPriority = document.getElementById('itemPriority');
  const itemImageInput = document.getElementById('itemImageInput');
  const imagePreview = document.getElementById('imagePreview');
  const saveItemBtn = document.getElementById('saveItemBtn');
  const cancelItemBtn = document.getElementById('cancelItemBtn');

  const shoppingList = document.getElementById('shoppingList');
  const emptyState = document.getElementById('emptyState');

  const detailModal = document.getElementById('detailModal');
  const closeDetailModal = document.getElementById('closeDetailModal');
  const detailName = document.getElementById('detailName');
  const detailMeta = document.getElementById('detailMeta');
  const detailDescription = document.getElementById('detailDescription');
  const detailNotes = document.getElementById('detailNotes');
  const detailImageWrap = document.getElementById('detailImageWrap');
  const editItemBtn = document.getElementById('editItemBtn');
  const deleteItemBtn = document.getElementById('deleteItemBtn');

  const imageModal = document.getElementById('imageModal');
  const imageModalImg = document.getElementById('imageModalImg');
  const closeImageModal = document.getElementById('closeImageModal');

  const displayNameInput = document.getElementById('display-name');
  const saveNameBtn = document.getElementById('save-name');
  const userIdDisplay = document.getElementById('userIdDisplay');

  const clearDoneBtn = document.getElementById('clearDoneBtn');
  const toggleTheme = document.getElementById('toggleTheme');

  const filterShowAll = document.getElementById('filterShowAll');
  const filterShowPending = document.getElementById('filterShowPending');

  // Local user id & name
  let userId = localStorage.getItem('ps_user_id');
  if (!userId) {
    userId = 'u_' + Math.random().toString(36).slice(2,9);
    localStorage.setItem('ps_user_id', userId);
  }
  userIdDisplay.textContent = 'ID: ' + userId;

  let userName = localStorage.getItem('ps_user_name') || '';
  displayNameInput.value = userName;

  saveNameBtn.addEventListener('click', () => {
    userName = displayNameInput.value.trim();
    localStorage.setItem('ps_user_name', userName);
    saveNameBtn.textContent = 'Αποθηκεύτηκε ✓';
    setTimeout(()=> saveNameBtn.textContent = 'Αποθήκευση', 1200);
  });

  // Dark mode
  let darkMode = localStorage.getItem('ps_dark_mode') === '1';
  function applyTheme() {
    if (darkMode) document.body.classList.add('dark-mode');
    else document.body.classList.remove('dark-mode');
  }
  applyTheme();
  toggleTheme.addEventListener('click', () => {
    darkMode = !darkMode;
    localStorage.setItem('ps_dark_mode', darkMode ? '1' : '0');
    applyTheme();
  });

  // State
  let lists = []; // { id, name }
  let selectedListId = null;
  let unsubscribeItems = null;
  let allItemsCache = []; // cache snapshot docs for client-side sort/filter

  // ---------- Lists CRUD ----------
  async function loadLists() {
    const snap = await listsCol.orderBy('createdAt','asc').get();
    lists = [];
    snap.forEach(d => lists.push({ id: d.id, ...d.data() }));
    renderListsSelect();
    if (!selectedListId && lists.length) {
      selectedListId = lists[0].id;
    }
    if (!selectedListId && lists.length === 0) {
      // create a default list
      const res = await listsCol.add({ name: 'Κύρια', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      selectedListId = res.id;
      lists.push({ id: res.id, name: 'Κύρια' });
    }
    if (selectedListId) listSelect.value = selectedListId;
    startItemsListener();
    renderListsCheckboxes();
  }

  function renderListsSelect() {
    listSelect.innerHTML = '';
    lists.forEach(l => {
      const opt = document.createElement('option');
      opt.value = l.id; opt.textContent = l.name;
      listSelect.appendChild(opt);
    });
  }

  function renderListsCheckboxes() {
    listsCheckboxes.innerHTML = '';
    lists.forEach(l => {
      const id = l.id;
      const wrap = document.createElement('label');
      wrap.className = 'flex items-center gap-2 p-1';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = id;
      cb.className = 'h-4 w-4';
      wrap.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = l.name;
      wrap.appendChild(span);
      listsCheckboxes.appendChild(wrap);
    });
  }

  addListBtn.addEventListener('click', () => {
    openListModal('add');
  });

  editListBtn.addEventListener('click', () => {
    if (!selectedListId) return alert('Επίλεξε μια λίστα πρώτα.');
    openListModal('edit');
  });

  removeListBtn.addEventListener('click', async () => {
    if (!selectedListId) return alert('Επίλεξε μια λίστα πρώτα.');
    const ok = confirm('Θες σίγουρα να διαγράψεις αυτή τη λίστα; (τα προϊόντα θα παραμείνουν ανήκουν και σε άλλες λίστες)');
    if (!ok) return;
    try {
      // Delete list doc (items in subcollection remain; they reference list ids)
      await listsCol.doc(selectedListId).delete();
      // Remove from local arrays and UI
      selectedListId = null;
      await loadLists();
    } catch (err) {
      console.error(err);
      alert('Σφάλμα κατά τη διαγραφή λίστας.');
    }
  });

  function openListModal(mode) {
    listModal.classList.remove('hidden');
    if (mode === 'add') {
      listModalTitle.textContent = 'Δημιουργία νέας λίστας';
      listNameInput.value = '';
      saveListBtn.dataset.mode = 'add';
    } else {
      listModalTitle.textContent = 'Επεξεργασία λίστας';
      const cur = lists.find(l => l.id === selectedListId);
      listNameInput.value = cur ? cur.name : '';
      saveListBtn.dataset.mode = 'edit';
    }
  }
  closeListModal.addEventListener('click', ()=> listModal.classList.add('hidden'));
  cancelListBtn.addEventListener('click', ()=> listModal.classList.add('hidden'));

  saveListBtn.addEventListener('click', async () => {
    const name = listNameInput.value.trim();
    if (!name) return alert('Δώσε όνομα λίστας.');
    const mode = saveListBtn.dataset.mode;
    try {
      if (mode === 'add') {
        const res = await listsCol.add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        lists.push({ id: res.id, name });
        selectedListId = res.id;
      } else {
        await listsCol.doc(selectedListId).update({ name });
      }
      listModal.classList.add('hidden');
      await loadLists();
      listSelect.value = selectedListId;
      renderListsCheckboxes();
    } catch (err) {
      console.error(err); alert('Σφάλμα αποθήκευσης λίστας.');
    }
  });

  listSelect.addEventListener('change', (e) => {
    selectedListId = e.target.value;
    startItemsListener();
  });

  // ---------- Items listener & render ----------
  function startItemsListener() {
    // unsubscribe previous
    if (unsubscribeItems) unsubscribeItems();
    if (!selectedListId) return;
    const itemsRef = listsCol.doc(selectedListId).collection('items') || db.collection('lists').doc(selectedListId).collection('items');
    // However we store items in root 'items' collection and track lists in field for multi-list support.
    // We'll instead listen to root items where 'lists' array contains selectedListId.
    const rootItemsRef = db.collection('items').where('lists', 'array-contains', selectedListId);
    unsubscribeItems = rootItemsRef.onSnapshot(snapshot => {
      allItemsCache = [];
      snapshot.forEach(doc => {
        const d = doc.data(); d.id = doc.id;
        allItemsCache.push(d);
      });
      renderItems();
    }, err => {
      console.error('snapshot err', err);
      // fallback: show empty
      allItemsCache = [];
      renderItems();
    });
  }

  // Helper to sort:
  // - not done items first, done items last
  // - within not-done: priority desc (3->1), then createdAt asc
  // - done items appear ordered by completedAt asc (or completedAt null fallback)
  function sortItems(a,b) {
    if (a.done !== b.done) return a.done ? 1 : -1; // done last
    if (!a.done) {
      // both pending
      const pa = (a.priority||1), pb = (b.priority||1);
      if (pa !== pb) return pb - pa; // higher priority first
      const ta = a.createdAt && a.createdAt.toMillis ? a.createdAt.toMillis() : 0;
      const tb = b.createdAt && b.createdAt.toMillis ? b.createdAt.toMillis() : 0;
      return ta - tb;
    } else {
      // both done
      const ca = a.completedAt && a.completedAt.toMillis ? a.completedAt.toMillis() : 0;
      const cb = b.completedAt && b.completedAt.toMillis ? b.completedAt.toMillis() : 0;
      return ca - cb;
    }
  }

  let currentFilter = 'all';
  filterShowAll.addEventListener('click', () => { currentFilter = 'all'; renderItems(); });
  filterShowPending.addEventListener('click', () => { currentFilter = 'pending'; renderItems(); });

  function renderItems() {
    shoppingList.innerHTML = '';
    if (!allItemsCache.length) {
      emptyState.classList.remove('hidden');
      return;
    } else {
      emptyState.classList.add('hidden');
    }
    // filter by pending/all
    let arr = allItemsCache.slice();
    if (currentFilter === 'pending') arr = arr.filter(i => !i.done);
    arr.sort(sortItems);
    arr.forEach(item => {
      const li = document.createElement('li');
      li.className = `list-item p-4 flex items-start justify-between ${'priority-' + (item.priority || 1)}`;
      li.dataset.id = item.id;

      // Left: toggle + text
      const left = document.createElement('div');
      left.className = 'flex gap-3 items-start';

      const chkBtn = document.createElement('button');
      chkBtn.className = 'w-9 h-9 rounded-full flex items-center justify-center border border-gray-200 mt-1';
      chkBtn.innerHTML = item.done ? '✔' : '';
      chkBtn.title = 'Σήμανση ως αγορασμένο';
      chkBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        try {
          const newDone = !item.done;
          const updateObj = { done: newDone };
          if (newDone) updateObj.completedAt = firebase.firestore.FieldValue.serverTimestamp();
          else updateObj.completedAt = null;
          await db.collection('items').doc(item.id).update(updateObj);
          // will reorder via snapshot
        } catch (err) {
          console.error(err); alert('Σφάλμα ενημέρωσης.');
        }
      });

      left.appendChild(chkBtn);

      const textWrap = document.createElement('div');
      textWrap.className = 'min-w-0';
      const title = document.createElement('div');
      title.className = item.done ? 'completed font-medium' : 'font-medium';
      title.textContent = item.text || '(Χωρίς όνομα)';

      // description under product as small text
      const desc = document.createElement('div');
      desc.className = 'small-desc mt-1';
      desc.textContent = item.description || '';
      desc.style.fontSize = '0.92rem';

      // thumbnail
      if (item.image) {
        const img = document.createElement('img');
        img.src = item.image;
        img.className = 'thumb mr-2';
        img.addEventListener('click', (ev) => {
          ev.stopPropagation();
          openImageModal(item.image);
        });
        // place image before title
        const row = document.createElement('div');
        row.className = 'flex items-start gap-3';
        row.appendChild(img);
        const col = document.createElement('div');
        col.appendChild(title);
        col.appendChild(desc);
        row.appendChild(col);
        textWrap.appendChild(row);
      } else {
        textWrap.appendChild(title);
        textWrap.appendChild(desc);
      }

      // meta line small
      const meta = document.createElement('div');
      meta.className = 'text-xs small-muted mt-1';
      const owner = item.ownerName || (item.ownerId || 'Άγνωστος');
      const prioMap = { '3':'Πολύ επείγον', '2':'Επείγον', '1':'Όταν μπορέσεις' };
      const pText = prioMap[String(item.priority || 1)];
      meta.textContent = `${owner} • ${pText}`;
      textWrap.appendChild(meta);

      left.appendChild(textWrap);

      // Right: no edit/delete here (per request); all edit/delete in detail modal
      const right = document.createElement('div');
      right.className = 'flex flex-col gap-2 items-end';

      // if item belongs to another user, show small badge
      if (item.ownerId && item.ownerId !== userId) {
        const badge = document.createElement('span');
        badge.className = 'text-xs px-2 py-1 rounded bg-gray-100 small-muted';
        badge.textContent = item.ownerName || 'Άλλος';
        right.appendChild(badge);
      }

      // Show priority label
      const prLbl = document.createElement('div');
      prLbl.className = 'text-sm font-medium small-muted';
      prLbl.textContent = pText;
      right.appendChild(prLbl);

      li.appendChild(left);
      li.appendChild(right);

      // click to open detail modal
      li.addEventListener('click', () => openDetailModal(item));

      shoppingList.appendChild(li);
    });
  }

  // ---------- Add/Edit item logic ----------
  let editingItemId = null;

  openAddModal.addEventListener('click', () => openItemModal());
  closeItemModal.addEventListener('click', () => itemModal.classList.add('hidden'));
  cancelItemBtn.addEventListener('click', () => itemModal.classList.add('hidden'));

  function openItemModal(item = null) {
    itemModal.classList.remove('hidden');
    if (item) {
      modalTitle.textContent = 'Επεξεργασία προϊόντος';
      editingItemId = item.id;
      itemName.value = item.text || '';
      itemDescription.value = item.description || '';
      itemNotes.value = item.notes || '';
      itemPriority.value = item.priority ? String(item.priority) : '1';
      // set lists checkboxes
      const cbs = listsCheckboxes.querySelectorAll('input[type=checkbox]');
      cbs.forEach(cb => cb.checked = item.lists && item.lists.includes(cb.value));
      // image preview
      if (item.image) imagePreview.innerHTML = `<img src="${item.image}" class="thumb" />`;
      else imagePreview.innerHTML = '';
      saveItemBtn.textContent = 'Ενημέρωση';
    } else {
      modalTitle.textContent = 'Προσθήκη προϊόντος';
      editingItemId = null;
      itemName.value = '';
      itemDescription.value = '';
      itemNotes.value = '';
      itemPriority.value = '1';
      const cbs = listsCheckboxes.querySelectorAll('input[type=checkbox]');
      cbs.forEach(cb => cb.checked = (cb.value === selectedListId)); // default select current list
      itemImageInput.value = '';
      imagePreview.innerHTML = '';
      saveItemBtn.textContent = 'Αποθήκευση';
    }
  }

  // image input to base64 preview
  itemImageInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) { imagePreview.innerHTML = ''; return; }
    const reader = new FileReader();
    reader.onload = () => {
      const data = reader.result;
      imagePreview.innerHTML = `<img src="${data}" class="thumb" />`;
      imagePreview.dataset.base64 = data;
    };
    reader.readAsDataURL(file);
  });

  async function gatherSelectedListsFromModal() {
    const cbs = listsCheckboxes.querySelectorAll('input[type=checkbox]');
    const sel = [];
    cbs.forEach(cb => { if (cb.checked) sel.push(cb.value); });
    // ensure selectedListId at least included
    if (sel.length === 0 && selectedListId) sel.push(selectedListId);
    return sel;
  }

  saveItemBtn.addEventListener('click', async () => {
    const text = itemName.value.trim();
    if (!text) return alert('Δώσε όνομα προϊόντος.');
    const description = itemDescription.value.trim();
    const notes = itemNotes.value.trim();
    const priority = parseInt(itemPriority.value || '1', 10);
    const listsSelected = await gatherSelectedListsFromModal();
    const imageBase64 = imagePreview.dataset.base64 || null;

    const payload = {
      text,
      description,
      notes,
      priority,
      lists: listsSelected,
      image: imageBase64,
      ownerId: userId,
      ownerName: userName || '',
      done: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      completedAt: null
    };

    try {
      if (editingItemId) {
        // update existing
        const updateObj = {
          text, description, notes, priority,
          lists: listsSelected, image: imageBase64, ownerName: userName || ''
        };
        await db.collection('items').doc(editingItemId).update(updateObj);
      } else {
        // create new item
        await db.collection('items').add(payload);
      }
      itemModal.classList.add('hidden');
      // reset
      imagePreview.innerHTML = '';
      delete imagePreview.dataset.base64;
    } catch (err) {
      console.error(err); alert('Σφάλμα αποθήκευσης προϊόντος.');
    }
  });

  // ---------- Detail modal ----------
  let currentDetailItem = null;
  function openDetailModal(item) {
    currentDetailItem = item;
    detailName.textContent = item.text || '(χωρίς όνομα)';
    const owner = item.ownerName || (item.ownerId || 'Άγνωστος');
    const prioMap = { '3':'Πολύ επείγον', '2':'Επείγον', '1':'Όταν μπορέσεις' };
    const pText = prioMap[String(item.priority || 1)];
    detailMeta.textContent = `${owner} • ${pText}`;
    detailDescription.textContent = item.description || '(χωρίς περιγραφή)';
    detailNotes.textContent = item.notes ? 'Σημειώσεις: ' + item.notes : '';
    if (item.image) {
      detailImageWrap.innerHTML = `<img src="${item.image}" alt="Φωτογραφία" class="mx-auto max-h-64 rounded-md cursor-pointer" />`;
      detailImageWrap.querySelector('img').addEventListener('click', ()=> openImageModal(item.image));
    } else detailImageWrap.innerHTML = '';
    detailModal.classList.remove('hidden');
  }
  closeDetailModal.addEventListener('click', ()=> detailModal.classList.add('hidden'));

  editItemBtn.addEventListener('click', () => {
    detailModal.classList.add('hidden');
    openItemModal(currentDetailItem);
  });

  deleteItemBtn.addEventListener('click', async () => {
    if (!currentDetailItem) return;
    const ok = confirm('Να διαγραφεί το προϊόν;');
    if (!ok) return;
    try {
      await db.collection('items').doc(currentDetailItem.id).delete();
      detailModal.classList.add('hidden');
    } catch (err) {
      console.error(err); alert('Σφάλμα κατά τη διαγραφή.');
    }
  });

  // ---------- Image modal ----------
  function openImageModal(dataUrl) {
    imageModalImg.src = dataUrl;
    imageModal.classList.remove('hidden');
  }
  closeImageModal.addEventListener('click', () => imageModal.classList.add('hidden'));

  // ---------- Clear done ----------
  clearDoneBtn.addEventListener('click', async () => {
    const ok = confirm('Να αφαιρεθούν όλα τα ολοκληρωμένα αντικείμενα;');
    if (!ok) return;
    try {
      const q = await db.collection('items').where('lists', 'array-contains', selectedListId).where('done','==',true).get();
      const batch = db.batch();
      q.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
    } catch (err) {
      console.error(err); alert('Σφάλμα κατά την εκκαθάριση.');
    }
  });

  // ---------- Initial load ----------
  async function initialSetup() {
    // ensure we have at least one list
    const snap = await listsCol.get();
    if (snap.empty) {
      const d = await listsCol.add({ name: 'Κύρια', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      selectedListId = d.id;
    }
    await loadLists();

    // ensure items collection exists (no-op)
  }
  initialSetup().catch(err => console.error('init err',err));

  // ------- Re-render lists checkboxes whenever lists change live -------
  listsCol.onSnapshot(() => {
    // reload lists
    loadLists().catch(()=>{});
  });

  // Also listen (root) items changes to keep allItemsCache updated globally (we already have listener for selected list)
  // To ensure multi-list visibility (items can belong to multiple lists), we listen per selected list only.

  // ---------- Service Worker registration (simple blob) ----------
  (async function registerSW() {
    if (!('serviceWorker' in navigator)) return;
    const swCode = `
      const CACHE = 'shopping-pwa-v1';
      const CORE = ['/', location.pathname || '/', '/manifest.json'];
      self.addEventListener('install', e => {
        self.skipWaiting();
        e.waitUntil(caches.open(CACHE).then(c => c.addAll(CORE.map(u => new Request(u, {cache: 'reload'}))).catch(()=>{})));
      });
      self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
      self.addEventListener('fetch', e => {
        if (e.request.method !== 'GET') return;
        e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).catch(()=> caches.match('/'))));
      });
    `;
    try {
      const blob = new Blob([swCode], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(swURL);
      console.log('SW registered');
    } catch (err) {
      console.warn('SW failed', err);
    }
  })();

  // Keep UI responsive when offline
  window.addEventListener('offline', () => console.log('offline'));
  window.addEventListener('online', () => console.log('online'));

  // Expose a small helper: when the user toggles "done", we set completedAt to timestamp so done items go to end
  // That logic is implemented in the toggle handler above.

  // Accessibility: close modals on Esc
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('[id$="Modal"]').forEach(m => m.classList.add('hidden'));
      itemModal.classList.add('hidden');
      detailModal.classList.add('hidden');
      listModal.classList.add('hidden');
      imageModal.classList.add('hidden');
    }
  });

  </script>

  <!-- Referenced Knowledge Files: [index.html, Planner.docx] -->
</body>
</html>

