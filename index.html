<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Συνεργατική Λίστα Αγορών</title>
    <!-- Tailwind CSS CDN για styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ρυθμίσεις PWA: Manifest και Service Worker -->
    <link rel="manifest" href="/manifest.json">
    <script>
        // ... existing manifest.json and service worker registration code ...
        // Δημιουργία απλού manifest.json δυναμικά για PWA
        const manifest = {
            "name": "Λίστα Αγορών",
            "short_name": "Ψώνια",
            "description": "Συνεργατική Λίστα Αγορών σε πραγματικό χρόνο",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0D9488",
            "theme_color": "#0D9488",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/10b981/ffffff?text=Ψ",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/10b981/ffffff?text=Ψ",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);

        // Καταχώρηση Service Worker για λειτουργία PWA (μόνο βασική cache)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(registration => console.log('SW registered: ', registration.scope))
                    .catch(error => console.log('SW registration failed: ', error));
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .purchase-btn { transition: transform 0.1s; }
        .purchase-btn:active { transform: scale(0.95); }
        .list-item:hover .purchase-btn { opacity: 1; }
        
        /* Στυλ για Modals */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        /* Χρώματα Προτεραιότητας */
        .priority-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .priority-high { background-color: #ef4444; /* red-500 */ }
        .priority-medium { background-color: #f59e0b; /* amber-500 */ }
        .priority-low { background-color: #22c55e; /* green-500 */ }
        
        /* Νέο: Για τα φίλτρα λίστας */
        .list-filter-chip {
            transition: all 0.15s ease-in-out;
        }
        .list-filter-chip.active {
            background-color: #0d9488; /* teal-700 */
            color: white;
            font-weight: 600;
            border-color: #0d9488;
        }
        .list-filter-chip:not(.active):hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Service Worker Script (sw.js) - Ενσωματωμένο -->
    <script id="sw-script" type="text/javascript">
        // ... existing service worker script (sw.js) ...
        // Αυτό το script εξυπηρετεί το sw.js
        const swContent = `
            const CACHE_NAME = 'shopping-list-cache-v1';
            const urlsToCache = [
                '/',
                'index.html',
                'https://cdn.tailwindcss.com',
                'https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap'
            ];

            self.addEventListener('install', event => {
                // Ανοίγει την cache και προσθέτει τα βασικά αρχεία
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Opened cache');
                            return cache.addAll(urlsToCache).catch(err => {
                                console.error('Failed to cache resources:', err);
                            });
                        })
                );
                // Διασφαλίζει ότι ο νέος SW αναλαμβάνει αμέσως
                self.skipWaiting();
            });

            self.addEventListener('fetch', event => {
                // Προσπαθεί να τραβήξει από το δίκτυο, αν αποτύχει, τραβάει από την cache
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            // Cache hit - επιστρέφει την απάντηση
                            if (response) {
                                return response;
                            }
                            // Cache miss - πηγαίνει στο δίκτυο
                            return fetch(event.request);
                        }
                    )
                );
            });

            self.addEventListener('activate', event => {
                const cacheWhitelist = [CACHE_NAME];
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                if (cacheWhitelist.indexOf(cacheName) === -1) {
                                    // Διαγράφει παλιές caches
                                    return caches.delete(cacheName);
                                }
                            })
                        );
                    })
                );
                // Διεκδικεί όλους τους πελάτες για να διασφαλίσει ότι όλα είναι υπό τον έλεγχο του SW
                return self.clients.claim();
            });
        `;

        function createServiceWorkerBlob() {
            const blob = new Blob([swContent], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }

        // Αντικατάσταση του path του SW με το Blob URL για να λειτουργήσει στο ενιαίο αρχείο
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                const originalRegister = navigator.serviceWorker.register;
                navigator.serviceWorker.register = (url, options) => {
                    if (url === '/sw.js') {
                        // Αντικαθιστούμε το /sw.js με το Blob URL
                        return originalRegister.call(navigator.serviceWorker, createServiceWorkerBlob(), options);
                    }
                    return originalRegister.call(navigator.serviceWorker, url, options);
                };
            }
        });
    </script>
    <!-- Τέλος Service Worker Script -->

    <div class="max-w-md mx-auto p-4 sm:p-6 bg-white shadow-xl min-h-screen pb-24">

        <!-- Επικεφαλίδα -->
        <header class="text-center mb-4">
            <h1 class="text-3xl font-extrabold text-teal-700">🛒 Η Κοινή Λίστα σας</h1>
            <p id="user-info" class="text-sm text-gray-500 mt-1"></p>
        </header>
        
        <!-- Controls: List Filter & Management -->
        <div class="flex flex-col gap-3 mb-4">
            <!-- Νέο container για φίλτρα λίστας -->
            <div class="border-b pb-3">
                 <label class="block text-sm font-medium text-gray-700 mb-2">Φιλτράρισμα Λίστας:</label>
                <div id="list-filter-container" class="flex flex-wrap gap-2">
                    <!-- Τα φίλτρα (chips) θα μπουν εδώ από JS -->
                </div>
            </div>
            
            <button id="manage-lists-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-lg transition duration-200" title="Διαχείριση Λιστών">
                Διαχείριση Λιστών
            </button>
        </div>


        <!-- Λίστα Αγορών -->
        <div class="flex justify-between items-center mb-3 border-b pb-2">
            <h2 class="text-xl font-bold text-teal-800">Αντικείμενα προς Αγορά:</h2>
            <button id="delete-checked-btn" class="flex-shrink-0 bg-red-100 text-red-700 hover:bg-red-200 text-xs font-bold py-1 px-2 rounded-lg transition duration-200" title="Διαγραφή Όσων Ελέγχθηκαν">
                Διαγραφή (Checked)
            </button>
        </div>
        <div id="shopping-list" class="space-y-3">
            <!-- Εδώ θα φορτωθούν τα αντικείμενα -->
            <p id="loading-msg" class="text-center text-gray-500 italic">Φόρτωση λίστας...</p>
        </div>

    </div>
    
    <!-- Floating Action Button (FAB) -->
    <button id="add-item-fab" class="fixed bottom-6 right-6 bg-teal-600 hover:bg-teal-700 text-white font-bold w-14 h-14 rounded-full shadow-lg flex items-center justify-center transform hover:scale-105 transition duration-200">
        <!-- SVG για + -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- Modal Προσθήκης/Επεξεργασίας Προϊόντος -->
    <div id="item-modal" class="modal fixed inset-0 z-30 bg-black bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <h2 id="item-modal-title" class="text-2xl font-bold text-gray-800 mb-4">Νέο Προϊόν</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                
                <div class="mb-4">
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Όνομα Προϊόντος</label>
                    <input type="text" id="item-name" class="w-full p-3 border-2 border-gray-300 rounded-lg" required>
                </div>
                
                <div class="flex gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Ποσότητα (π.χ. 1L)</label>
                        <input type="text" id="item-quantity" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    </div>
                    <div class="flex-grow">
                        <label for="item-priority" class="block text-sm font-medium text-gray-700 mb-1">Προτεραιότητα</label>
                        <select id="item-priority" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white">
                            <option value="medium">Επείγον</option>
                            <option value="high">Πολύ Επείγον</option>
                            <option value="low">Μόλις Μπορέσω</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="item-description" class="block text-sm font-medium text-gray-700 mb-1">Περιγραφή/Σημειώσεις</label>
                    <textarea id="item-description" rows="2" class="w-full p-3 border-2 border-gray-300 rounded-lg"></textarea>
                </div>

                <div class="mb-6">
                    <label for="item-list" class="block text-sm font-medium text-gray-700 mb-1">Λίστα</label>
                    <select id="item-list" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white" required>
                        <!-- Επιλογές λίστας θα φορτωθούν εδώ -->
                    </select>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-item-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-xl transition duration-200">Ακύρωση</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-xl transition duration-200">Αποθήκευση</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Διαχείρισης Λιστών -->
    <div id="list-modal" class="modal fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Διαχείριση Λιστών</h2>
            
            <form id="list-form" class="flex gap-2 mb-4">
                <input type="text" id="list-name-input" placeholder="Όνομα νέας λίστας" class="w-full p-3 border-2 border-gray-300 rounded-lg" required>
                <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200">Προσθήκη</button>
            </form>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">Υπάρχουσες Λίστες:</h3>
            <div id="list-management-container" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Οι λίστες για διαχείριση θα μπουν εδώ -->
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" id="close-list-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-xl transition duration-200">Κλείσιμο</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK και Λογική Εφαρμογής -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc, setLogLevel, query, orderBy, serverTimestamp, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ... existing firebase setup ...
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Νέα global state
        let allLists = [];
        let allItems = [];
        // let currentListFilter = "all"; // Πλέον δεν χρησιμοποιείται
        let activeListFilters = ['all']; // Νέο state
        let itemListenerUnsubscribe = null;
        let listListenerUnsubscribe = null;

        // UI Elements
        const shoppingListElement = document.getElementById('shopping-list');
        const loadingMsg = document.getElementById('loading-msg');
        const userInfo = document.getElementById('user-info');
        // const listSelector = document.getElementById('list-selector'); // ΔΙΑΓΡΑΦΗΚΕ
        const listFilterContainer = document.getElementById('list-filter-container'); // ΝΕΟ
        const deleteCheckedBtn = document.getElementById('delete-checked-btn'); // ΝΕΟ
        const manageListsBtn = document.getElementById('manage-lists-btn');
        
        // FAB
        const addItemFab = document.getElementById('add-item-fab');
        
        // Item Modal
        const itemModal = document.getElementById('item-modal');
        const itemModalTitle = document.getElementById('item-modal-title');
        const itemForm = document.getElementById('item-form');
        const cancelItemBtn = document.getElementById('cancel-item-btn');
        const itemIdInput = document.getElementById('item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemQuantityInput = document.getElementById('item-quantity');
        const itemPriorityInput = document.getElementById('item-priority');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemListSelect = document.getElementById('item-list');
        
        // List Modal
        const listModal = document.getElementById('list-modal');
        const listForm = document.getElementById('list-form');
        const listNameInput = document.getElementById('list-name-input');
        const listManagementContainer = document.getElementById('list-management-container');
        const closeListModalBtn = document.getElementById('close-list-modal-btn');


        // 1. Εκκίνηση Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            shoppingListElement.innerHTML = `<p class="text-red-500 text-center">Σφάλμα: Αδύνατη η σύνδεση με τη βάση δεδομένων.</p>`;
        }


        // 2. Έλεγχος Αυθεντικοποίησης
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const shortUserId = userId.substring(0, 8);
                userInfo.textContent = `Συνδεδεμένος Χρήστης ID: ${shortUserId}...`;
                isAuthReady = true;
                console.log("Authenticated User ID:", userId);
                // Ξεκινάμε την ακρόαση
                listenToLists();
                listenToItems();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        const result = await signInAnonymously(auth);
                        userId = result.user.uid;
                        userInfo.textContent = `Ανώνυμος Χρήστης ID: ${userId.substring(0, 8)}...`;
                        isAuthReady = true;
                        console.log("Signed in anonymously. New User ID:", userId);
                        listenToLists();
                        listenToItems();
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    loadingMsg.textContent = "Σφάλμα Αυθεντικοποίησης.";
                }
            }
        });


        // 3. Firestore Paths
        function getListCollectionPath() {
            return `artifacts/${appId}/public/data/lists`;
        }
        function getItemCollectionPath() {
            return `artifacts/${appId}/public/data/items`;
        }

        // 4. Real-time Listeners
        function listenToLists() {
            if (listListenerUnsubscribe) listListenerUnsubscribe();
            
            const q = query(collection(db, getListCollectionPath()), orderBy('name'));
            listListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Lists updated:", allLists);
                populateListDropdowns(); // Αυτό γεμίζει το modal dropdown
                populateListFilters(); // ΝΕΟ: Γεμίζει τα chips
                populateListManagementUI();
                renderItems(); // Re-render items in case list name changed
            }, (error) => {
                console.error("Error listening to lists:", error);
            });
        }
        
        function listenToItems() {
            if (itemListenerUnsubscribe) itemListenerUnsubscribe();

            const q = query(collection(db, getItemCollectionPath()), orderBy('timestamp', 'desc'));
            itemListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Items updated:", allItems);
                renderItems();
            }, (error) => {
                console.error("Error listening to items:", error);
                loadingMsg.textContent = "Σφάλμα φόρτωσης προϊόντων.";
            });
        }

        // 5. Render Functions
        function renderItems() {
            loadingMsg.style.display = 'none';
            shoppingListElement.innerHTML = '';

            // 1. Filter
            const filteredItems = allItems.filter(item => {
                // Αν το 'all' είναι ενεργό, δείξε τα όλα
                if (activeListFilters.includes('all')) return true;
                // Αλλιώς, δείξε μόνο αν το listId του item είναι μέσα στα ενεργά φίλτρα
                return activeListFilters.includes(item.listId);
            });

            // 2. Sort (by priority AND completed status)
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            const sortedItems = filteredItems.sort((a, b) => {
                // Checkbox sort: Unchecked items (false) come first
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1; // (false < true)
                }

                // Priority sort
                const priorityA = priorityOrder[a.priority] || 99;
                const priorityB = priorityOrder[b.priority] || 99;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                
                // Fallback to timestamp (newest first)
                return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
            });

            if (sortedItems.length === 0) {
                shoppingListElement.innerHTML = `<p class="text-center text-gray-500 mt-4 p-4 bg-gray-50 rounded-xl">Η λίστα είναι άδεια!</p>`;
                return;
            }

            sortedItems.forEach(item => {
                const itemElement = createListItem(item);
                shoppingListElement.appendChild(itemElement);
            });
        }

        function createListItem(item) {
            const element = document.createElement('div');
            // Προσθήκη 'opacity-60' αν είναι checked
            const checkedClass = item.completed ? 'opacity-60' : '';
            element.className = `list-item flex items-center bg-white p-3 pr-2 rounded-xl shadow transition duration-150 hover:shadow-lg ${checkedClass}`;
            
            let priorityClass = '';
            if (item.priority === 'high') priorityClass = 'priority-high';
            else if (item.priority === 'medium') priorityClass = 'priority-medium';
            else if (item.priority === 'low') priorityClass = 'priority-low';

            const list = allLists.find(l => l.id === item.listId);
            const listName = list ? list.name : 'Άγνωστη Λίστα';
            
            // Νέα κλάση για strikethrough
            const textClass = item.completed ? 'line-through text-gray-500' : 'text-gray-800';

            element.innerHTML = `
                <!-- Νέο Checkbox -->
                <input type="checkbox" data-id="${item.id}" class="item-checkbox flex-shrink-0 h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mr-3" ${item.completed ? 'checked' : ''}>
                
                <div class="priority-dot mr-3 ${priorityClass}"></div>
                <div class="flex-grow min-w-0"> <!-- Προσθήκη min-w-0 για σωστό word-break -->
                    <span class="text-lg font-medium ${textClass} break-words">${item.name}</span>
                    <div class="text-sm ${textClass} truncate">
                        ${item.quantity ? `<span class="font-semibold">${item.quantity}</span> | ` : ''}
                        ${(activeListFilters.includes('all') || activeListFilters.length > 1) ? `<span>${listName}</span>` : ''}
                    </div>
                    ${item.description ? `<p class="text-sm ${textClass} mt-1 break-words">${item.description}</p>` : ''}
                </div>
                <button data-id="${item.id}" class="edit-btn flex-shrink-0 text-gray-400 hover:text-blue-500 p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button data-id="${item.id}" class="purchase-btn flex-shrink-0 bg-green-500 hover:bg-green-600 text-white p-2 rounded-full shadow-md text-sm leading-none flex items-center justify-center ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;

            element.querySelector('.purchase-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteItem(item.id);
            });
            
            element.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openItemModal(item);
            });

            // Νέος listener για το checkbox
            element.querySelector('.item-checkbox').addEventListener('click', (e) => {
                // e.stopPropagation(); // Δεν χρειάζεται, αφήνει το event να πάει
                const docId = e.target.dataset.id;
                const isChecked = e.target.checked;
                updateItemCheckedStatus(docId, isChecked);
            });

            return element;
        }

        function populateListDropdowns() {
            // const currentMainVal = listSelector.value; // ΔΙΑΓΡΑΦΗΚΕ
            const currentItemVal = itemListSelect.value;
            
            // listSelector.innerHTML = '<option value="all">Όλες οι Λίστες</option>'; // ΔΙΑΓΡΑΦΗΚΕ
            itemListSelect.innerHTML = '';
            
            if(allLists.length === 0) {
                itemListSelect.innerHTML = '<option value="">Δημιουργήστε μια λίστα πρώτα</option>';
            }

            allLists.forEach(list => {
                // listSelector.innerHTML += `<option value="${list.id}">${list.name}</option>`; // ΔΙΑΓΡΑΦΗΚΕ
                itemListSelect.innerHTML += `<option value="${list.id}">${list.name}</option>`;
            });
            
            // listSelector.value = allLists.some(l => l.id === currentMainVal) ? currentMainVal : 'all'; // ΔΙΑΓΡΑΦΗΚΕ
            itemListSelect.value = allLists.some(l => l.id === currentItemVal) ? currentItemVal : (allLists[0]?.id || '');
        }
        
        // ΝΕΑ ΣΥΝΑΡΤΗΣΗ: populateListFilters (για τα chips)
        function populateListFilters() {
            listFilterContainer.innerHTML = '';
            
            // 1. Add "All" chip
            const allChip = createFilterChip('all', 'Όλες');
            listFilterContainer.appendChild(allChip);

            // 2. Add chips for each list
            allLists.forEach(list => {
                const listChip = createFilterChip(list.id, list.name);
                listFilterContainer.appendChild(listChip);
            });
        }
        
        // ΝΕΑ ΣΥΝΑΡΤΗΣΗ: createFilterChip
        function createFilterChip(listId, name) {
            const chip = document.createElement('button');
            chip.className = 'list-filter-chip border border-gray-300 text-gray-700 text-sm font-medium py-1 px-3 rounded-full';
            chip.textContent = name;
            chip.dataset.id = listId;
            
            if (activeListFilters.includes(listId)) {
                chip.classList.add('active');
            }
            
            chip.addEventListener('click', () => {
                const id = chip.dataset.id;
                
                // Logic for "All" vs. specific lists
                if (id === 'all') {
                    // Αν πατήθηκε το "Όλες", γίνεται το μόνο ενεργό
                    activeListFilters = ['all'];
                } else {
                    // Αφαίρεση του "Όλες" αν υπήρχε
                    if (activeListFilters.includes('all')) {
                        activeListFilters = [];
                    }
                    
                    // Handle multi-select
                    const index = activeListFilters.indexOf(id);
                    if (index > -1) {
                        // Ηταν ενεργό, το αφαιρούμε
                        activeListFilters.splice(index, 1);
                    } else {
                        // Δεν ήταν ενεργό, το προσθέτουμε
                        activeListFilters.push(id);
                    }
                    
                    // Αν μείνει κενό, επιστρέφουμε στο "Όλες"
                    if (activeListFilters.length === 0) {
                        activeListFilters = ['all'];
                    }
                }
                
                // Update UI (chips)
                Array.from(listFilterContainer.children).forEach(c => {
                    c.classList.toggle('active', activeListFilters.includes(c.dataset.id));
                });
                
                // Re-render the item list
                renderItems();
            });
            return chip;
        }

        function populateListManagementUI() {
            listManagementContainer.innerHTML = '';
            if (allLists.length === 0) {
                 listManagementContainer.innerHTML = '<p class="text-gray-500 italic">Δεν υπάρχουν λίστες.</p>';
                 return;
            }
            
            allLists.forEach(list => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                el.innerHTML = `
                    <input type="text" value="${list.name}" data-id="${list.id}" class="list-name-edit-input flex-grow bg-transparent font-medium text-gray-700 p-1 rounded border border-transparent focus:border-teal-500 focus:bg-white">
                `;
                // TODO: Add delete button
                listManagementContainer.appendChild(el);
            });
            
            listManagementContainer.querySelectorAll('.list-name-edit-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const newName = e.target.value.trim();
                    const listId = e.target.dataset.id;
                    if (newName && listId) {
                        try {
                            await updateDoc(doc(db, getListCollectionPath(), listId), { name: newName });
                            alertMessage("Η λίστα ενημερώθηκε!", "success");
                        } catch (err) {
                            console.error("Error updating list name:", err);
                            alertMessage("Αποτυχία ενημέρωσης.", "error");
                        }
                    }
                });
            });
        }


        // 6. CRUD Functions
        async function handleItemFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const itemId = itemIdInput.value;
            const itemData = {
                name: itemNameInput.value.trim(),
                quantity: itemQuantityInput.value.trim(),
                priority: itemPriorityInput.value,
                description: itemDescriptionInput.value.trim(),
                listId: itemListSelect.value,
                updatedBy: userId,
            };

            if (itemData.name === "" || itemData.listId === "") {
                alertMessage("Το Όνομα και η Λίστα είναι υποχρεωτικά.", "error");
                return;
            }

            try {
                if (itemId) {
                    // Update
                    await updateDoc(doc(db, getItemCollectionPath(), itemId), itemData);
                    alertMessage("Το προϊόν ενημερώθηκε!", "success");
                } else {
                    // Add New
                    itemData.addedBy = userId;
                    itemData.timestamp = serverTimestamp();
                    itemData.completed = false; // ΝΕΟ: Set default completed status
                    await addDoc(collection(db, getItemCollectionPath()), itemData);
                    alertMessage("Το προϊόν προστέθηκε!", "success");
                }
                closeItemModal();
            } catch (err) {
                console.error("Error saving item:", err);
                alertMessage("Αποτυχία αποθήκευσης.", "error");
            }
        }
        
        // ΝΕΑ ΣΥΝΑΡΤΗΣΗ
        async function updateItemCheckedStatus(docId, isChecked) {
            if (!isAuthReady) return;
            try {
                await updateDoc(doc(db, getItemCollectionPath(), docId), {
                    completed: isChecked,
                    updatedBy: userId
                });
                // No alert needed, UI will update via onSnapshot (και το re-render)
                console.log(`Item ${docId} checked status set to ${isChecked}`);
            } catch (e) {
                console.error("Error updating checked status:", e);
                alertMessage("Αποτυχία ενημέρωσης.", "error");
            }
        }
        
        async function deleteItem(docId) {
            if (!isAuthReady) return;
            try {
                await deleteDoc(doc(db, getItemCollectionPath(), docId));
                alertMessage("Το αντικείμενο αφαιρέθηκε (αγοράστηκε)!", "success");
            } catch (e) {
                console.error("Error removing document: ", e);
                alertMessage("Αποτυχία διαγραφής.", "error");
            }
        }
        
        // ΝΕΑ ΣΥΝΑΡΤΗΣΗ
        async function deleteCheckedItems() {
            if (!isAuthReady) return;
            
            const itemsToDelete = allItems.filter(item => item.completed === true);
            if (itemsToDelete.length === 0) {
                alertMessage("Δεν υπάρχουν τσεκαρισμένα αντικείμενα για διαγραφή.", "info");
                return;
            }
            
            // !! ΣΗΜΑΝΤΙΚΟ: Χωρίς confirmation modal (όπως το alert), 
            // αυτό είναι επικίνδυνο. Προς το παρόν, διαγράφει κατευθείαν.
            console.log(`Deleting ${itemsToDelete.length} items...`);
            
            // Χρησιμοποιούμε Promise.all για να τρέξουν παράλληλα οι διαγραφές
            const deletePromises = itemsToDelete.map(item => {
                return deleteDoc(doc(db, getItemCollectionPath(), item.id));
            });
            
            try {
                await Promise.all(deletePromises);
                alertMessage(`Διαγράφηκαν ${itemsToDelete.length} αντικείμενα!`, "success");
            } catch (e) {
                console.error("Error deleting checked items:", e);
                alertMessage("Παρουσιάστηκε σφάλμα κατά τη διαγραφή.", "error");
            }
        }
        
        async function handleListFormSubmit(e) {
            e.preventDefault();
            const newName = listNameInput.value.trim();
            if (newName) {
                try {
                    await addDoc(collection(db, getListCollectionPath()), {
                        name: newName,
                        createdBy: userId,
                        timestamp: serverTimestamp()
                    });
                    listNameInput.value = '';
                    alertMessage("Η λίστα προστέθηκε!", "success");
                } catch (err) {
                    console.error("Error adding list:", err);
                    alertMessage("Αποτυχία προσθήκης λίστας.", "error");
                }
            }
        }

        // 7. Modal Controls
        function openItemModal(item = null) {
            itemForm.reset();
            if (item) {
                // Edit Mode
                itemModalTitle.textContent = "Επεξεργασία Προϊόντος";
                itemIdInput.value = item.id;
                itemNameInput.value = item.name;
                itemQuantityInput.value = item.quantity || '';
                itemPriorityInput.value = item.priority || 'medium';
                itemDescriptionInput.value = item.description || '';
                itemListSelect.value = item.listId;
            } else {
                // Add Mode
                itemModalTitle.textContent = "Νέο Προϊόν";
                itemIdInput.value = '';
                // Set default list based on filter
                // Αν είναι επιλεγμένη μόνο μία λίστα, βάλε την ως default
                if (activeListFilters.length === 1 && activeListFilters[0] !== 'all') {
                    itemListSelect.value = activeListFilters[0];
                } else {
                    // Αλλιώς, βάλε την πρώτη διαθέσιμη λίστα
                    itemListSelect.value = (allLists[0]?.id || '');
                }
            }
            itemModal.classList.remove('invisible', 'opacity-0');
            itemModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeItemModal() {
            itemModal.classList.add('opacity-0');
            itemModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => itemModal.classList.add('invisible'), 200);
        }
        
        function openListModal() {
            listModal.classList.remove('invisible', 'opacity-0');
            listModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeListModal() {
            listModal.classList.add('opacity-0');
            listModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => listModal.classList.add('invisible'), 200);
        }
        
        // 8. Χειρισμός Ειδοποιήσεων (αντί για alert)
        function alertMessage(message, type = 'info') {
            // ... (same alertMessage function as before) ...
            const container = document.getElementById('shopping-list');
            const alertBox = document.createElement('div');
            const baseClasses = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-semibold transition-all duration-300';
            
            let typeClasses;
            if (type === 'success') {
                typeClasses = 'bg-green-500';
            } else if (type === 'error') {
                typeClasses = 'bg-red-500';
            } else {
                typeClasses = 'bg-blue-500';
            }

            alertBox.className = `${baseClasses} ${typeClasses} opacity-0 scale-95`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            // Εμφάνιση
            setTimeout(() => {
                alertBox.classList.remove('opacity-0', 'scale-95');
            }, 50);

            // Απόκρυψη
            setTimeout(() => {
                alertBox.classList.add('opacity-0', 'scale-95');
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        // 9. Event Listeners
        /* ΔΙΑΓΡΑΦΗΚΕ
        listSelector.addEventListener('change', () => {
            currentListFilter = listSelector.value;
            renderItems();
        });
        */
        
        // ΝΕΟ
        deleteCheckedBtn.addEventListener('click', deleteCheckedItems);
        
        addItemFab.addEventListener('click', () => openItemModal(null));
        itemForm.addEventListener('submit', handleItemFormSubmit);
        cancelItemBtn.addEventListener('click', closeItemModal);
        
        manageListsBtn.addEventListener('click', openListModal);
        listForm.addEventListener('submit', handleListFormSubmit);
        closeListModalBtn.addEventListener('click', closeListModal);

    </script>
</body>
</html>


