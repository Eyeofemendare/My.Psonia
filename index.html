<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î£Ï…Î½ÎµÏÎ³Î±Ï„Î¹ÎºÎ® Î›Î¯ÏƒÏ„Î± Î‘Î³Î¿ÏÏÎ½</title>
    <!-- Tailwind CSS CDN Î³Î¹Î± styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ PWA: Manifest ÎºÎ±Î¹ Service Worker -->
    <link rel="manifest" href="/manifest.json">
    <script>
        // ... existing manifest.json and service worker registration code ...
        // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î±Ï€Î»Î¿Ï manifest.json Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ Î³Î¹Î± PWA
        const manifest = {
            "name": "Î›Î¯ÏƒÏ„Î± Î‘Î³Î¿ÏÏÎ½",
            "short_name": "Î¨ÏÎ½Î¹Î±",
            "description": "Î£Ï…Î½ÎµÏÎ³Î±Ï„Î¹ÎºÎ® Î›Î¯ÏƒÏ„Î± Î‘Î³Î¿ÏÏÎ½ ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0D9488",
            "theme_color": "#0D9488",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/10b981/ffffff?text=Î¨",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/10b981/ffffff?text=Î¨",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.querySelector('link[rel="manifest"]').setAttribute('href', manifestUrl);

        // ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Service Worker Î³Î¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± PWA (Î¼ÏŒÎ½Î¿ Î²Î±ÏƒÎ¹ÎºÎ® cache)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(registration => console.log('SW registered: ', registration.scope))
                    .catch(error => console.log('SW registration failed: ', error));
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .purchase-btn { transition: transform 0.1s; }
        .purchase-btn:active { transform: scale(0.95); }
        .list-item:hover .purchase-btn { opacity: 1; }
        
        /* Î£Ï„Ï…Î» Î³Î¹Î± Modals */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        /* Î§ÏÏÎ¼Î±Ï„Î± Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚ */
        .priority-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .priority-high { background-color: #ef4444; /* red-500 */ }
        .priority-medium { background-color: #f59e0b; /* amber-500 */ }
        .priority-low { background-color: #22c55e; /* green-500 */ }
        
        /* ÎÎ­Î¿: Î“Î¹Î± Ï„Î± Ï†Î¯Î»Ï„ÏÎ± Î»Î¯ÏƒÏ„Î±Ï‚ */
        .list-filter-chip {
            transition: all 0.15s ease-in-out;
        }
        .list-filter-chip.active {
            background-color: #0d9488; /* teal-700 */
            color: white;
            font-weight: 600;
            border-color: #0d9488;
        }
        .list-filter-chip:not(.active):hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Service Worker Script (sw.js) - Î•Î½ÏƒÏ‰Î¼Î±Ï„Ï‰Î¼Î­Î½Î¿ -->
    <script id="sw-script" type="text/javascript">
        // ... existing service worker script (sw.js) ...
        // Î‘Ï…Ï„ÏŒ Ï„Î¿ script ÎµÎ¾Ï…Ï€Î·ÏÎµÏ„ÎµÎ¯ Ï„Î¿ sw.js
        const swContent = `
            const CACHE_NAME = 'shopping-list-cache-v1';
            const urlsToCache = [
                '/',
                'index.html',
                'https://cdn.tailwindcss.com',
                'https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap'
            ];

            self.addEventListener('install', event => {
                // Î‘Î½Î¿Î¯Î³ÎµÎ¹ Ï„Î·Î½ cache ÎºÎ±Î¹ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„ÎµÎ¹ Ï„Î± Î²Î±ÏƒÎ¹ÎºÎ¬ Î±ÏÏ‡ÎµÎ¯Î±
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(cache => {
                            console.log('Opened cache');
                            return cache.addAll(urlsToCache).catch(err => {
                                console.error('Failed to cache resources:', err);
                            });
                        })
                );
                // Î”Î¹Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ ÏŒÏ„Î¹ Î¿ Î½Î­Î¿Ï‚ SW Î±Î½Î±Î»Î±Î¼Î²Î¬Î½ÎµÎ¹ Î±Î¼Î­ÏƒÏ‰Ï‚
                self.skipWaiting();
            });

            self.addEventListener('fetch', event => {
                // Î ÏÎ¿ÏƒÏ€Î±Î¸ÎµÎ¯ Î½Î± Ï„ÏÎ±Î²Î®Î¾ÎµÎ¹ Î±Ï€ÏŒ Ï„Î¿ Î´Î¯ÎºÏ„Ï…Î¿, Î±Î½ Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹, Ï„ÏÎ±Î²Î¬ÎµÎ¹ Î±Ï€ÏŒ Ï„Î·Î½ cache
                event.respondWith(
                    caches.match(event.request)
                        .then(response => {
                            // Cache hit - ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ Ï„Î·Î½ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·
                            if (response) {
                                return response;
                            }
                            // Cache miss - Ï€Î·Î³Î±Î¯Î½ÎµÎ¹ ÏƒÏ„Î¿ Î´Î¯ÎºÏ„Ï…Î¿
                            return fetch(event.request);
                        }
                    )
                );
            });

            self.addEventListener('activate', event => {
                const cacheWhitelist = [CACHE_NAME];
                event.waitUntil(
                    caches.keys().then(cacheNames => {
                        return Promise.all(
                            cacheNames.map(cacheName => {
                                if (cacheWhitelist.indexOf(cacheName) === -1) {
                                    // Î”Î¹Î±Î³ÏÎ¬Ï†ÎµÎ¹ Ï€Î±Î»Î¹Î­Ï‚ caches
                                    return caches.delete(cacheName);
                                }
                            })
                        );
                    })
                );
                // Î”Î¹ÎµÎºÎ´Î¹ÎºÎµÎ¯ ÏŒÎ»Î¿Ï…Ï‚ Ï„Î¿Ï…Ï‚ Ï€ÎµÎ»Î¬Ï„ÎµÏ‚ Î³Î¹Î± Î½Î± Î´Î¹Î±ÏƒÏ†Î±Î»Î¯ÏƒÎµÎ¹ ÏŒÏ„Î¹ ÏŒÎ»Î± ÎµÎ¯Î½Î±Î¹ Ï…Ï€ÏŒ Ï„Î¿Î½ Î­Î»ÎµÎ³Ï‡Î¿ Ï„Î¿Ï… SW
                return self.clients.claim();
            });
        `;

        function createServiceWorkerBlob() {
            const blob = new Blob([swContent], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }

        // Î‘Î½Ï„Î¹ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Ï„Î¿Ï… path Ï„Î¿Ï… SW Î¼Îµ Ï„Î¿ Blob URL Î³Î¹Î± Î½Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ ÏƒÏ„Î¿ ÎµÎ½Î¹Î±Î¯Î¿ Î±ÏÏ‡ÎµÎ¯Î¿
        document.addEventListener('DOMContentLoaded', () => {
            if ('serviceWorker' in navigator) {
                const originalRegister = navigator.serviceWorker.register;
                navigator.serviceWorker.register = (url, options) => {
                    if (url === '/sw.js') {
                        // Î‘Î½Ï„Î¹ÎºÎ±Î¸Î¹ÏƒÏ„Î¿ÏÎ¼Îµ Ï„Î¿ /sw.js Î¼Îµ Ï„Î¿ Blob URL
                        return originalRegister.call(navigator.serviceWorker, createServiceWorkerBlob(), options);
                    }
                    return originalRegister.call(navigator.serviceWorker, url, options);
                };
            }
        });
    </script>
    <!-- Î¤Î­Î»Î¿Ï‚ Service Worker Script -->

    <div class="max-w-md mx-auto p-4 sm:p-6 bg-white shadow-xl min-h-screen pb-24">

        <!-- Î•Ï€Î¹ÎºÎµÏ†Î±Î»Î¯Î´Î± -->
        <header class="text-center mb-4">
            <h1 class="text-3xl font-extrabold text-teal-700">ğŸ›’ Î— ÎšÎ¿Î¹Î½Î® Î›Î¯ÏƒÏ„Î± ÏƒÎ±Ï‚</h1>
            <p id="user-info" class="text-sm text-gray-500 mt-1"></p>
        </header>
        
        <!-- Controls: List Filter & Management -->
        <div class="flex flex-col gap-3 mb-4">
            <!-- ÎÎ­Î¿ container Î³Î¹Î± Ï†Î¯Î»Ï„ÏÎ± Î»Î¯ÏƒÏ„Î±Ï‚ -->
            <div class="border-b pb-3">
                 <label class="block text-sm font-medium text-gray-700 mb-2">Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î›Î¯ÏƒÏ„Î±Ï‚:</label>
                <div id="list-filter-container" class="flex flex-wrap gap-2">
                    <!-- Î¤Î± Ï†Î¯Î»Ï„ÏÎ± (chips) Î¸Î± Î¼Ï€Î¿Ï…Î½ ÎµÎ´Ï Î±Ï€ÏŒ JS -->
                </div>
            </div>
            
            <button id="manage-lists-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold p-3 rounded-lg transition duration-200" title="Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î›Î¹ÏƒÏ„ÏÎ½">
                Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î›Î¹ÏƒÏ„ÏÎ½
            </button>
        </div>


        <!-- Î›Î¯ÏƒÏ„Î± Î‘Î³Î¿ÏÏÎ½ -->
        <div class="flex justify-between items-center mb-3 border-b pb-2">
            <h2 class="text-xl font-bold text-teal-800">Î‘Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± Ï€ÏÎ¿Ï‚ Î‘Î³Î¿ÏÎ¬:</h2>
            <button id="delete-checked-btn" class="flex-shrink-0 bg-red-100 text-red-700 hover:bg-red-200 text-xs font-bold py-1 px-2 rounded-lg transition duration-200" title="Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎŒÏƒÏ‰Î½ Î•Î»Î­Î³Ï‡Î¸Î·ÎºÎ±Î½">
                Î”Î¹Î±Î³ÏÎ±Ï†Î® (Checked)
            </button>
        </div>
        <div id="shopping-list" class="space-y-3">
            <!-- Î•Î´Ï Î¸Î± Ï†Î¿ÏÏ„Ï‰Î¸Î¿ÏÎ½ Ï„Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± -->
            <p id="loading-msg" class="text-center text-gray-500 italic">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î»Î¯ÏƒÏ„Î±Ï‚...</p>
        </div>

    </div>
    
    <!-- Floating Action Button (FAB) -->
    <button id="add-item-fab" class="fixed bottom-6 right-6 bg-teal-600 hover:bg-teal-700 text-white font-bold w-14 h-14 rounded-full shadow-lg flex items-center justify-center transform hover:scale-105 transition duration-200">
        <!-- SVG Î³Î¹Î± + -->
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>
    
    <!-- Modal Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚/Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±Ï‚ Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚ -->
    <div id="item-modal" class="modal fixed inset-0 z-30 bg-black bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <h2 id="item-modal-title" class="text-2xl font-bold text-gray-800 mb-4">ÎÎ­Î¿ Î ÏÎ¿ÏŠÏŒÎ½</h2>
            <form id="item-form">
                <input type="hidden" id="item-id">
                
                <div class="mb-4">
                    <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">ÎŒÎ½Î¿Î¼Î± Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚</label>
                    <input type="text" id="item-name" class="w-full p-3 border-2 border-gray-300 rounded-lg" required>
                </div>
                
                <div class="flex gap-4 mb-4">
                    <div class="flex-grow">
                        <label for="item-quantity" class="block text-sm font-medium text-gray-700 mb-1">Î Î¿ÏƒÏŒÏ„Î·Ï„Î± (Ï€.Ï‡. 1L)</label>
                        <input type="text" id="item-quantity" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    </div>
                    <div class="flex-grow">
                        <label for="item-priority" class="block text-sm font-medium text-gray-700 mb-1">Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±</label>
                        <select id="item-priority" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white">
                            <option value="medium">Î•Ï€ÎµÎ¯Î³Î¿Î½</option>
                            <option value="high">Î Î¿Î»Ï Î•Ï€ÎµÎ¯Î³Î¿Î½</option>
                            <option value="low">ÎœÏŒÎ»Î¹Ï‚ ÎœÏ€Î¿ÏÎ­ÏƒÏ‰</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="item-description" class="block text-sm font-medium text-gray-700 mb-1">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®/Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚</label>
                    <textarea id="item-description" rows="2" class="w-full p-3 border-2 border-gray-300 rounded-lg"></textarea>
                </div>

                <div class="mb-6">
                    <label for="item-list" class="block text-sm font-medium text-gray-700 mb-1">Î›Î¯ÏƒÏ„Î±</label>
                    <select id="item-list" class="w-full p-3 border-2 border-gray-300 rounded-lg bg-white" required>
                        <!-- Î•Ï€Î¹Î»Î¿Î³Î­Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚ Î¸Î± Ï†Î¿ÏÏ„Ï‰Î¸Î¿ÏÎ½ ÎµÎ´Ï -->
                    </select>
                </div>
                
                <div class="flex justify-end gap-3">
                    <button type="button" id="cancel-item-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-xl transition duration-200">Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                    <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-5 rounded-xl transition duration-200">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·Ï‚ Î›Î¹ÏƒÏ„ÏÎ½ -->
    <div id="list-modal" class="modal fixed inset-0 z-40 bg-black bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-xl shadow-2xl transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î›Î¹ÏƒÏ„ÏÎ½</h2>
            
            <form id="list-form" class="flex gap-2 mb-4">
                <input type="text" id="list-name-input" placeholder="ÎŒÎ½Î¿Î¼Î± Î½Î­Î±Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚" class="w-full p-3 border-2 border-gray-300 rounded-lg" required>
                <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
            </form>

            <h3 class="text-lg font-semibold text-gray-700 mb-2">Î¥Ï€Î¬ÏÏ‡Î¿Ï…ÏƒÎµÏ‚ Î›Î¯ÏƒÏ„ÎµÏ‚:</h3>
            <div id="list-management-container" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- ÎŸÎ¹ Î»Î¯ÏƒÏ„ÎµÏ‚ Î³Î¹Î± Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î¸Î± Î¼Ï€Î¿Ï…Î½ ÎµÎ´Ï -->
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" id="close-list-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-5 rounded-xl transition duration-200">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK ÎºÎ±Î¹ Î›Î¿Î³Î¹ÎºÎ® Î•Ï†Î±ÏÎ¼Î¿Î³Î®Ï‚ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc, setLogLevel, query, orderBy, serverTimestamp, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ... existing firebase setup ...
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // ÎÎ­Î± global state
        let allLists = [];
        let allItems = [];
        // let currentListFilter = "all"; // Î Î»Î­Î¿Î½ Î´ÎµÎ½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹
        let activeListFilters = ['all']; // ÎÎ­Î¿ state
        let itemListenerUnsubscribe = null;
        let listListenerUnsubscribe = null;

        // UI Elements
        const shoppingListElement = document.getElementById('shopping-list');
        const loadingMsg = document.getElementById('loading-msg');
        const userInfo = document.getElementById('user-info');
        // const listSelector = document.getElementById('list-selector'); // Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
        const listFilterContainer = document.getElementById('list-filter-container'); // ÎÎ•ÎŸ
        const deleteCheckedBtn = document.getElementById('delete-checked-btn'); // ÎÎ•ÎŸ
        const manageListsBtn = document.getElementById('manage-lists-btn');
        
        // FAB
        const addItemFab = document.getElementById('add-item-fab');
        
        // Item Modal
        const itemModal = document.getElementById('item-modal');
        const itemModalTitle = document.getElementById('item-modal-title');
        const itemForm = document.getElementById('item-form');
        const cancelItemBtn = document.getElementById('cancel-item-btn');
        const itemIdInput = document.getElementById('item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemQuantityInput = document.getElementById('item-quantity');
        const itemPriorityInput = document.getElementById('item-priority');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemListSelect = document.getElementById('item-list');
        
        // List Modal
        const listModal = document.getElementById('list-modal');
        const listForm = document.getElementById('list-form');
        const listNameInput = document.getElementById('list-name-input');
        const listManagementContainer = document.getElementById('list-management-container');
        const closeListModalBtn = document.getElementById('close-list-modal-btn');


        // 1. Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            shoppingListElement.innerHTML = `<p class="text-red-500 text-center">Î£Ï†Î¬Î»Î¼Î±: Î‘Î´ÏÎ½Î±Ï„Î· Î· ÏƒÏÎ½Î´ÎµÏƒÎ· Î¼Îµ Ï„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½.</p>`;
        }


        // 2. ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚ Î‘Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const shortUserId = userId.substring(0, 8);
                userInfo.textContent = `Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·Ï‚ ID: ${shortUserId}...`;
                isAuthReady = true;
                console.log("Authenticated User ID:", userId);
                // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î·Î½ Î±ÎºÏÏŒÎ±ÏƒÎ·
                listenToLists();
                listenToItems();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token.");
                    } else {
                        const result = await signInAnonymously(auth);
                        userId = result.user.uid;
                        userInfo.textContent = `Î‘Î½ÏÎ½Ï…Î¼Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·Ï‚ ID: ${userId.substring(0, 8)}...`;
                        isAuthReady = true;
                        console.log("Signed in anonymously. New User ID:", userId);
                        listenToLists();
                        listenToItems();
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    loadingMsg.textContent = "Î£Ï†Î¬Î»Î¼Î± Î‘Ï…Î¸ÎµÎ½Ï„Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚.";
                }
            }
        });


        // 3. Firestore Paths
        function getListCollectionPath() {
            return `artifacts/${appId}/public/data/lists`;
        }
        function getItemCollectionPath() {
            return `artifacts/${appId}/public/data/items`;
        }

        // 4. Real-time Listeners
        function listenToLists() {
            if (listListenerUnsubscribe) listListenerUnsubscribe();
            
            const q = query(collection(db, getListCollectionPath()), orderBy('name'));
            listListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Lists updated:", allLists);
                populateListDropdowns(); // Î‘Ï…Ï„ÏŒ Î³ÎµÎ¼Î¯Î¶ÎµÎ¹ Ï„Î¿ modal dropdown
                populateListFilters(); // ÎÎ•ÎŸ: Î“ÎµÎ¼Î¯Î¶ÎµÎ¹ Ï„Î± chips
                populateListManagementUI();
                renderItems(); // Re-render items in case list name changed
            }, (error) => {
                console.error("Error listening to lists:", error);
            });
        }
        
        function listenToItems() {
            if (itemListenerUnsubscribe) itemListenerUnsubscribe();

            const q = query(collection(db, getItemCollectionPath()), orderBy('timestamp', 'desc'));
            itemListenerUnsubscribe = onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Items updated:", allItems);
                renderItems();
            }, (error) => {
                console.error("Error listening to items:", error);
                loadingMsg.textContent = "Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½.";
            });
        }

        // 5. Render Functions
        function renderItems() {
            loadingMsg.style.display = 'none';
            shoppingListElement.innerHTML = '';

            // 1. Filter
            const filteredItems = allItems.filter(item => {
                // Î‘Î½ Ï„Î¿ 'all' ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒ, Î´ÎµÎ¯Î¾Îµ Ï„Î± ÏŒÎ»Î±
                if (activeListFilters.includes('all')) return true;
                // Î‘Î»Î»Î¹ÏÏ‚, Î´ÎµÎ¯Î¾Îµ Î¼ÏŒÎ½Î¿ Î±Î½ Ï„Î¿ listId Ï„Î¿Ï… item ÎµÎ¯Î½Î±Î¹ Î¼Î­ÏƒÎ± ÏƒÏ„Î± ÎµÎ½ÎµÏÎ³Î¬ Ï†Î¯Î»Ï„ÏÎ±
                return activeListFilters.includes(item.listId);
            });

            // 2. Sort (by priority AND completed status)
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            const sortedItems = filteredItems.sort((a, b) => {
                // Checkbox sort: Unchecked items (false) come first
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1; // (false < true)
                }

                // Priority sort
                const priorityA = priorityOrder[a.priority] || 99;
                const priorityB = priorityOrder[b.priority] || 99;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                
                // Fallback to timestamp (newest first)
                return (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0);
            });

            if (sortedItems.length === 0) {
                shoppingListElement.innerHTML = `<p class="text-center text-gray-500 mt-4 p-4 bg-gray-50 rounded-xl">Î— Î»Î¯ÏƒÏ„Î± ÎµÎ¯Î½Î±Î¹ Î¬Î´ÎµÎ¹Î±!</p>`;
                return;
            }

            sortedItems.forEach(item => {
                const itemElement = createListItem(item);
                shoppingListElement.appendChild(itemElement);
            });
        }

        function createListItem(item) {
            const element = document.createElement('div');
            // Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· 'opacity-60' Î±Î½ ÎµÎ¯Î½Î±Î¹ checked
            const checkedClass = item.completed ? 'opacity-60' : '';
            element.className = `list-item flex items-center bg-white p-3 pr-2 rounded-xl shadow transition duration-150 hover:shadow-lg ${checkedClass}`;
            
            let priorityClass = '';
            if (item.priority === 'high') priorityClass = 'priority-high';
            else if (item.priority === 'medium') priorityClass = 'priority-medium';
            else if (item.priority === 'low') priorityClass = 'priority-low';

            const list = allLists.find(l => l.id === item.listId);
            const listName = list ? list.name : 'Î†Î³Î½Ï‰ÏƒÏ„Î· Î›Î¯ÏƒÏ„Î±';
            
            // ÎÎ­Î± ÎºÎ»Î¬ÏƒÎ· Î³Î¹Î± strikethrough
            const textClass = item.completed ? 'line-through text-gray-500' : 'text-gray-800';

            element.innerHTML = `
                <!-- ÎÎ­Î¿ Checkbox -->
                <input type="checkbox" data-id="${item.id}" class="item-checkbox flex-shrink-0 h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mr-3" ${item.completed ? 'checked' : ''}>
                
                <div class="priority-dot mr-3 ${priorityClass}"></div>
                <div class="flex-grow min-w-0"> <!-- Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· min-w-0 Î³Î¹Î± ÏƒÏ‰ÏƒÏ„ÏŒ word-break -->
                    <span class="text-lg font-medium ${textClass} break-words">${item.name}</span>
                    <div class="text-sm ${textClass} truncate">
                        ${item.quantity ? `<span class="font-semibold">${item.quantity}</span> | ` : ''}
                        ${(activeListFilters.includes('all') || activeListFilters.length > 1) ? `<span>${listName}</span>` : ''}
                    </div>
                    ${item.description ? `<p class="text-sm ${textClass} mt-1 break-words">${item.description}</p>` : ''}
                </div>
                <button data-id="${item.id}" class="edit-btn flex-shrink-0 text-gray-400 hover:text-blue-500 p-2 rounded-full transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button data-id="${item.id}" class="purchase-btn flex-shrink-0 bg-green-500 hover:bg-green-600 text-white p-2 rounded-full shadow-md text-sm leading-none flex items-center justify-center ml-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;

            element.querySelector('.purchase-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteItem(item.id);
            });
            
            element.querySelector('.edit-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openItemModal(item);
            });

            // ÎÎ­Î¿Ï‚ listener Î³Î¹Î± Ï„Î¿ checkbox
            element.querySelector('.item-checkbox').addEventListener('click', (e) => {
                // e.stopPropagation(); // Î”ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹, Î±Ï†Î®Î½ÎµÎ¹ Ï„Î¿ event Î½Î± Ï€Î¬ÎµÎ¹
                const docId = e.target.dataset.id;
                const isChecked = e.target.checked;
                updateItemCheckedStatus(docId, isChecked);
            });

            return element;
        }

        function populateListDropdowns() {
            // const currentMainVal = listSelector.value; // Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
            const currentItemVal = itemListSelect.value;
            
            // listSelector.innerHTML = '<option value="all">ÎŒÎ»ÎµÏ‚ Î¿Î¹ Î›Î¯ÏƒÏ„ÎµÏ‚</option>'; // Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
            itemListSelect.innerHTML = '';
            
            if(allLists.length === 0) {
                itemListSelect.innerHTML = '<option value="">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î¼Î¹Î± Î»Î¯ÏƒÏ„Î± Ï€ÏÏÏ„Î±</option>';
            }

            allLists.forEach(list => {
                // listSelector.innerHTML += `<option value="${list.id}">${list.name}</option>`; // Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
                itemListSelect.innerHTML += `<option value="${list.id}">${list.name}</option>`;
            });
            
            // listSelector.value = allLists.some(l => l.id === currentMainVal) ? currentMainVal : 'all'; // Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
            itemListSelect.value = allLists.some(l => l.id === currentItemVal) ? currentItemVal : (allLists[0]?.id || '');
        }
        
        // ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—: populateListFilters (Î³Î¹Î± Ï„Î± chips)
        function populateListFilters() {
            listFilterContainer.innerHTML = '';
            
            // 1. Add "All" chip
            const allChip = createFilterChip('all', 'ÎŒÎ»ÎµÏ‚');
            listFilterContainer.appendChild(allChip);

            // 2. Add chips for each list
            allLists.forEach(list => {
                const listChip = createFilterChip(list.id, list.name);
                listFilterContainer.appendChild(listChip);
            });
        }
        
        // ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—: createFilterChip
        function createFilterChip(listId, name) {
            const chip = document.createElement('button');
            chip.className = 'list-filter-chip border border-gray-300 text-gray-700 text-sm font-medium py-1 px-3 rounded-full';
            chip.textContent = name;
            chip.dataset.id = listId;
            
            if (activeListFilters.includes(listId)) {
                chip.classList.add('active');
            }
            
            chip.addEventListener('click', () => {
                const id = chip.dataset.id;
                
                // Logic for "All" vs. specific lists
                if (id === 'all') {
                    // Î‘Î½ Ï€Î±Ï„Î®Î¸Î·ÎºÎµ Ï„Î¿ "ÎŒÎ»ÎµÏ‚", Î³Î¯Î½ÎµÏ„Î±Î¹ Ï„Î¿ Î¼ÏŒÎ½Î¿ ÎµÎ½ÎµÏÎ³ÏŒ
                    activeListFilters = ['all'];
                } else {
                    // Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï„Î¿Ï… "ÎŒÎ»ÎµÏ‚" Î±Î½ Ï…Ï€Î®ÏÏ‡Îµ
                    if (activeListFilters.includes('all')) {
                        activeListFilters = [];
                    }
                    
                    // Handle multi-select
                    const index = activeListFilters.indexOf(id);
                    if (index > -1) {
                        // Î—Ï„Î±Î½ ÎµÎ½ÎµÏÎ³ÏŒ, Ï„Î¿ Î±Ï†Î±Î¹ÏÎ¿ÏÎ¼Îµ
                        activeListFilters.splice(index, 1);
                    } else {
                        // Î”ÎµÎ½ Î®Ï„Î±Î½ ÎµÎ½ÎµÏÎ³ÏŒ, Ï„Î¿ Ï€ÏÎ¿ÏƒÎ¸Î­Ï„Î¿Ï…Î¼Îµ
                        activeListFilters.push(id);
                    }
                    
                    // Î‘Î½ Î¼ÎµÎ¯Î½ÎµÎ¹ ÎºÎµÎ½ÏŒ, ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ ÏƒÏ„Î¿ "ÎŒÎ»ÎµÏ‚"
                    if (activeListFilters.length === 0) {
                        activeListFilters = ['all'];
                    }
                }
                
                // Update UI (chips)
                Array.from(listFilterContainer.children).forEach(c => {
                    c.classList.toggle('active', activeListFilters.includes(c.dataset.id));
                });
                
                // Re-render the item list
                renderItems();
            });
            return chip;
        }

        function populateListManagementUI() {
            listManagementContainer.innerHTML = '';
            if (allLists.length === 0) {
                 listManagementContainer.innerHTML = '<p class="text-gray-500 italic">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î»Î¯ÏƒÏ„ÎµÏ‚.</p>';
                 return;
            }
            
            allLists.forEach(list => {
                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                el.innerHTML = `
                    <input type="text" value="${list.name}" data-id="${list.id}" class="list-name-edit-input flex-grow bg-transparent font-medium text-gray-700 p-1 rounded border border-transparent focus:border-teal-500 focus:bg-white">
                `;
                // TODO: Add delete button
                listManagementContainer.appendChild(el);
            });
            
            listManagementContainer.querySelectorAll('.list-name-edit-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const newName = e.target.value.trim();
                    const listId = e.target.dataset.id;
                    if (newName && listId) {
                        try {
                            await updateDoc(doc(db, getListCollectionPath(), listId), { name: newName });
                            alertMessage("Î— Î»Î¯ÏƒÏ„Î± ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!", "success");
                        } catch (err) {
                            console.error("Error updating list name:", err);
                            alertMessage("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚.", "error");
                        }
                    }
                });
            });
        }


        // 6. CRUD Functions
        async function handleItemFormSubmit(e) {
            e.preventDefault();
            if (!isAuthReady) return;

            const itemId = itemIdInput.value;
            const itemData = {
                name: itemNameInput.value.trim(),
                quantity: itemQuantityInput.value.trim(),
                priority: itemPriorityInput.value,
                description: itemDescriptionInput.value.trim(),
                listId: itemListSelect.value,
                updatedBy: userId,
            };

            if (itemData.name === "" || itemData.listId === "") {
                alertMessage("Î¤Î¿ ÎŒÎ½Î¿Î¼Î± ÎºÎ±Î¹ Î· Î›Î¯ÏƒÏ„Î± ÎµÎ¯Î½Î±Î¹ Ï…Ï€Î¿Ï‡ÏÎµÏ‰Ï„Î¹ÎºÎ¬.", "error");
                return;
            }

            try {
                if (itemId) {
                    // Update
                    await updateDoc(doc(db, getItemCollectionPath(), itemId), itemData);
                    alertMessage("Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎµ!", "success");
                } else {
                    // Add New
                    itemData.addedBy = userId;
                    itemData.timestamp = serverTimestamp();
                    itemData.completed = false; // ÎÎ•ÎŸ: Set default completed status
                    await addDoc(collection(db, getItemCollectionPath()), itemData);
                    alertMessage("Î¤Î¿ Ï€ÏÎ¿ÏŠÏŒÎ½ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!", "success");
                }
                closeItemModal();
            } catch (err) {
                console.error("Error saving item:", err);
                alertMessage("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚.", "error");
            }
        }
        
        // ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—
        async function updateItemCheckedStatus(docId, isChecked) {
            if (!isAuthReady) return;
            try {
                await updateDoc(doc(db, getItemCollectionPath(), docId), {
                    completed: isChecked,
                    updatedBy: userId
                });
                // No alert needed, UI will update via onSnapshot (ÎºÎ±Î¹ Ï„Î¿ re-render)
                console.log(`Item ${docId} checked status set to ${isChecked}`);
            } catch (e) {
                console.error("Error updating checked status:", e);
                alertMessage("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·Ï‚.", "error");
            }
        }
        
        async function deleteItem(docId) {
            if (!isAuthReady) return;
            try {
                await deleteDoc(doc(db, getItemCollectionPath(), docId));
                alertMessage("Î¤Î¿ Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Î±Ï†Î±Î¹ÏÎ­Î¸Î·ÎºÎµ (Î±Î³Î¿ÏÎ¬ÏƒÏ„Î·ÎºÎµ)!", "success");
            } catch (e) {
                console.error("Error removing document: ", e);
                alertMessage("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚.", "error");
            }
        }
        
        // ÎÎ•Î‘ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î—
        async function deleteCheckedItems() {
            if (!isAuthReady) return;
            
            const itemsToDelete = allItems.filter(item => item.completed === true);
            if (itemsToDelete.length === 0) {
                alertMessage("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„ÏƒÎµÎºÎ±ÏÎ¹ÏƒÎ¼Î­Î½Î± Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î± Î³Î¹Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®.", "info");
                return;
            }
            
            // !! Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: Î§Ï‰ÏÎ¯Ï‚ confirmation modal (ÏŒÏ€Ï‰Ï‚ Ï„Î¿ alert), 
            // Î±Ï…Ï„ÏŒ ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¹ÎºÎ¯Î½Î´Ï…Î½Î¿. Î ÏÎ¿Ï‚ Ï„Î¿ Ï€Î±ÏÏŒÎ½, Î´Î¹Î±Î³ÏÎ¬Ï†ÎµÎ¹ ÎºÎ±Ï„ÎµÏ…Î¸ÎµÎ¯Î±Î½.
            console.log(`Deleting ${itemsToDelete.length} items...`);
            
            // Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Promise.all Î³Î¹Î± Î½Î± Ï„ÏÎ­Î¾Î¿Ï…Î½ Ï€Î±ÏÎ¬Î»Î»Î·Î»Î± Î¿Î¹ Î´Î¹Î±Î³ÏÎ±Ï†Î­Ï‚
            const deletePromises = itemsToDelete.map(item => {
                return deleteDoc(doc(db, getItemCollectionPath(), item.id));
            });
            
            try {
                await Promise.all(deletePromises);
                alertMessage(`Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎ±Î½ ${itemsToDelete.length} Î±Î½Ï„Î¹ÎºÎµÎ¯Î¼ÎµÎ½Î±!`, "success");
            } catch (e) {
                console.error("Error deleting checked items:", e);
                alertMessage("Î Î±ÏÎ¿Ï…ÏƒÎ¹Î¬ÏƒÏ„Î·ÎºÎµ ÏƒÏ†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®.", "error");
            }
        }
        
        async function handleListFormSubmit(e) {
            e.preventDefault();
            const newName = listNameInput.value.trim();
            if (newName) {
                try {
                    await addDoc(collection(db, getListCollectionPath()), {
                        name: newName,
                        createdBy: userId,
                        timestamp: serverTimestamp()
                    });
                    listNameInput.value = '';
                    alertMessage("Î— Î»Î¯ÏƒÏ„Î± Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ!", "success");
                } catch (err) {
                    console.error("Error adding list:", err);
                    alertMessage("Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ Î»Î¯ÏƒÏ„Î±Ï‚.", "error");
                }
            }
        }

        // 7. Modal Controls
        function openItemModal(item = null) {
            itemForm.reset();
            if (item) {
                // Edit Mode
                itemModalTitle.textContent = "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î ÏÎ¿ÏŠÏŒÎ½Ï„Î¿Ï‚";
                itemIdInput.value = item.id;
                itemNameInput.value = item.name;
                itemQuantityInput.value = item.quantity || '';
                itemPriorityInput.value = item.priority || 'medium';
                itemDescriptionInput.value = item.description || '';
                itemListSelect.value = item.listId;
            } else {
                // Add Mode
                itemModalTitle.textContent = "ÎÎ­Î¿ Î ÏÎ¿ÏŠÏŒÎ½";
                itemIdInput.value = '';
                // Set default list based on filter
                // Î‘Î½ ÎµÎ¯Î½Î±Î¹ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î· Î¼ÏŒÎ½Î¿ Î¼Î¯Î± Î»Î¯ÏƒÏ„Î±, Î²Î¬Î»Îµ Ï„Î·Î½ Ï‰Ï‚ default
                if (activeListFilters.length === 1 && activeListFilters[0] !== 'all') {
                    itemListSelect.value = activeListFilters[0];
                } else {
                    // Î‘Î»Î»Î¹ÏÏ‚, Î²Î¬Î»Îµ Ï„Î·Î½ Ï€ÏÏÏ„Î· Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Î»Î¯ÏƒÏ„Î±
                    itemListSelect.value = (allLists[0]?.id || '');
                }
            }
            itemModal.classList.remove('invisible', 'opacity-0');
            itemModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeItemModal() {
            itemModal.classList.add('opacity-0');
            itemModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => itemModal.classList.add('invisible'), 200);
        }
        
        function openListModal() {
            listModal.classList.remove('invisible', 'opacity-0');
            listModal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function closeListModal() {
            listModal.classList.add('opacity-0');
            listModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => listModal.classList.add('invisible'), 200);
        }
        
        // 8. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Î•Î¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½ (Î±Î½Ï„Î¯ Î³Î¹Î± alert)
        function alertMessage(message, type = 'info') {
            // ... (same alertMessage function as before) ...
            const container = document.getElementById('shopping-list');
            const alertBox = document.createElement('div');
            const baseClasses = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-lg shadow-xl z-50 text-white font-semibold transition-all duration-300';
            
            let typeClasses;
            if (type === 'success') {
                typeClasses = 'bg-green-500';
            } else if (type === 'error') {
                typeClasses = 'bg-red-500';
            } else {
                typeClasses = 'bg-blue-500';
            }

            alertBox.className = `${baseClasses} ${typeClasses} opacity-0 scale-95`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ·
            setTimeout(() => {
                alertBox.classList.remove('opacity-0', 'scale-95');
            }, 50);

            // Î‘Ï€ÏŒÎºÏÏ…ÏˆÎ·
            setTimeout(() => {
                alertBox.classList.add('opacity-0', 'scale-95');
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        // 9. Event Listeners
        /* Î”Î™Î‘Î“Î¡Î‘Î¦Î—ÎšÎ•
        listSelector.addEventListener('change', () => {
            currentListFilter = listSelector.value;
            renderItems();
        });
        */
        
        // ÎÎ•ÎŸ
        deleteCheckedBtn.addEventListener('click', deleteCheckedItems);
        
        addItemFab.addEventListener('click', () => openItemModal(null));
        itemForm.addEventListener('submit', handleItemFormSubmit);
        cancelItemBtn.addEventListener('click', closeItemModal);
        
        manageListsBtn.addEventListener('click', openListModal);
        listForm.addEventListener('submit', handleListFormSubmit);
        closeListModalBtn.addEventListener('click', closeListModal);

    </script>
</body>
</html>


