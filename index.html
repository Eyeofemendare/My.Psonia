<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Συνεργατική Λίστα Αγορών</title>
    <!-- Tailwind CSS CDN για styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-500': '#0D9488', // Teal 700
                        'primary-600': '#0F766E', // Teal 800
                        'accent': '#F59E0B', // Amber 500
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Ρυθμίσεις PWA: Manifest και Service Worker -->
    <link rel="manifest" href="/manifest.json">
    <script>
        // FIX 1: Utility function to convert UTF-8 string to Base64 safe string
        function utf8ToBase64(str) {
            // Encode the string as URI component to handle UTF-8, then convert to Latin-1 safe characters for btoa
            return btoa(unescape(encodeURIComponent(str)));
        }

        // Δημιουργία απλού manifest.json δυναμικά για PWA
        const manifest = {
            "name": "Λίστα Αγορών",
            "short_name": "Ψώνια",
            "description": "Συνεργατική Λίστα Αγορών σε πραγματικό χρόνο",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#0D9488",
            "theme_color": "#0D9488",
            "icons": [
                {
                    "src": "https://placehold.co/192x192/10b981/ffffff?text=Ψ",
                    "sizes": "192x192",
                    "type": "image/png"
                },
                {
                    "src": "https://placehold.co/512x512/10b981/ffffff?text=Ψ",
                    "sizes": "512x512",
                    "type": "image/png"
                }
            ]
        };

        // Χρησιμοποιούμε τη νέα συνάρτηση για την ασφαλή κωδικοποίηση Base64
        const manifestUrl = 'data:application/json;base64,' + utf8ToBase64(JSON.stringify(manifest));
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);

        // Service Worker (Διατήρηση για PWA, αν και δεν είναι απαραίτητο για το Canvas)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('SW registered: ', registration);
                }).catch(registrationError => {
                    console.log('SW registration failed: ', registrationError);
                });
            });
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased">

    <!-- Κεντρικό Περιεχόμενο -->
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-primary-600 tracking-tight">Συνεργατική Λίστα Αγορών</h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <main class="bg-white p-6 rounded-xl shadow-2xl">
            <!-- Φόρμα Προσθήκης Είδους (Κρυφή) -->
            <div id="item-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-3xl p-6 w-full max-w-md transform transition-all scale-100 opacity-100">
                    <h2 id="item-modal-title" class="text-2xl font-bold mb-4 text-primary-600">Προσθήκη Είδους</h2>
                    <form id="item-form">
                        <input type="hidden" id="item-id-input">
                        
                        <div class="mb-4">
                            <label for="item-name" class="block text-sm font-medium text-gray-700 mb-1">Όνομα Είδους</label>
                            <input type="text" id="item-name" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150"
                                   placeholder="π.χ. Γάλα 2L, Ντομάτες">
                        </div>
                        
                        <div class="mb-4">
                            <label for="item-list-id" class="block text-sm font-medium text-gray-700 mb-1">Λίστα</label>
                            <select id="item-list-id" required 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                                <!-- Οι επιλογές θα φορτωθούν εδώ -->
                            </select>
                        </div>

                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" id="cancel-item-btn" 
                                    class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 font-medium">
                                Ακύρωση
                            </button>
                            <button type="submit" id="save-item-btn" 
                                    class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition duration-150 font-medium shadow-md hover:shadow-lg">
                                Αποθήκευση
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Λίστες και Φίλτρα -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                <div class="flex items-center space-x-3 w-full md:w-auto">
                    <!-- ΝΕΟ: Dropdown για φιλτράρισμα -->
                    <label for="list-selector" class="text-sm font-medium text-gray-700 whitespace-nowrap">Δείτε τη λίστα:</label>
                    <select id="list-selector" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg text-sm transition duration-150">
                        <option value="all">Όλες οι λίστες</option>
                        <!-- Οι επιλογές θα φορτωθούν εδώ -->
                    </select>
                </div>
                
                <div class="flex space-x-2 w-full md:w-auto">
                    <button id="delete-checked-btn" 
                            class="flex-1 md:flex-none px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 text-sm font-medium shadow-md">
                        Διαγραφή Επιλεγμένων
                    </button>
                    <!-- ΝΕΟ: Gemini AI Feature Button -->
                    <button id="generate-recipe-btn" 
                            class="flex-1 md:flex-none px-4 py-2 bg-accent text-gray-900 rounded-lg hover:bg-amber-600 transition duration-150 text-sm font-medium shadow-md">
                        ✨ Προτείνετε Συνταγή
                    </button>
                    <button id="manage-lists-btn" 
                            class="flex-1 md:flex-none px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 text-sm font-medium shadow-md">
                        Διαχείριση Λιστών
                    </button>
                </div>
            </div>

            <!-- Λίστα Ειδών -->
            <div id="items-container" class="space-y-3">
                <p class="text-center text-gray-500 italic" id="empty-list-message">Προσθέστε είδη για να ξεκινήσετε...</p>
            </div>

        </main>

        <!-- Floating Action Button για Προσθήκη Είδους -->
        <button id="add-item-fab" 
                class="fixed bottom-6 right-6 w-14 h-14 bg-primary-500 text-white rounded-full shadow-lg hover:bg-primary-600 transition duration-300 flex items-center justify-center text-3xl font-bold z-40">
            +
        </button>
    </div>

    <!-- Modal Διαχείρισης Λιστών -->
    <div id="list-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-3xl p-6 w-full max-w-lg transform transition-all scale-100 opacity-100">
            <h2 class="text-2xl font-bold mb-4 text-primary-600">Διαχείριση Λιστών</h2>
            
            <form id="list-form" class="mb-4 flex space-x-2">
                <input type="text" id="list-name-input" required placeholder="Νέα Λίστα (π.χ. Κουζίνα)"
                       class="flex-grow px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150">
                <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 font-medium">
                    Προσθήκη
                </button>
            </form>

            <div id="lists-display" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                <!-- Οι λίστες θα εμφανιστούν εδώ -->
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" id="close-list-modal-btn" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 font-medium">
                    Κλείσιμο
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Προβολής Συνταγής -->
    <div id="recipe-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-3xl p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto transform transition-all scale-100 opacity-100">
            <h2 class="text-2xl font-bold mb-2 text-primary-600" id="recipe-title"></h2>
            <p class="text-sm text-gray-500 mb-4 italic" id="recipe-description"></p>
            
            <h3 class="text-xl font-semibold mt-4 mb-2 text-gray-700 border-b pb-1">Υλικά (Ingredients)</h3>
            <ul id="recipe-ingredients" class="list-disc list-inside space-y-1 text-gray-600 pl-4"></ul>
            
            <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-700 border-b pb-1">Εκτέλεση (Instructions)</h3>
            <ol id="recipe-instructions" class="list-decimal list-inside space-y-2 text-gray-700 pl-4"></ol>

            <div class="flex justify-end mt-6">
                <button type="button" id="close-recipe-modal-btn" 
                        class="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 font-medium">
                    Κλείσιμο
                </button>
            </div>
        </div>
    </div>


    <!-- Firebase, Firestore, και Auth Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // FIX 2: Αφαιρέθηκε η διπλή δήλωση του 'addDoc'
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, arrayRemove, arrayUnion, runTransaction, writeBatch, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Βασικές Μεταβλητές & Αρχικοποίηση
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentListFilter = 'all';

        const ITEMS_COLLECTION_PATH = `/artifacts/${appId}/public/data/shopping_items`;
        const LISTS_COLLECTION_PATH = `/artifacts/${appId}/public/data/shopping_lists`;
        
        // Καταστάσεις εφαρμογής
        let items = []; // Όλα τα είδη
        let lists = []; // Όλες οι λίστες
        
        // UI Elements
        const authStatus = document.getElementById('auth-status');
        const itemsContainer = document.getElementById('items-container');
        const emptyListMessage = document.getElementById('empty-list-message');
        const listSelector = document.getElementById('list-selector');

        const addItemFab = document.getElementById('add-item-fab');
        const deleteCheckedBtn = document.getElementById('delete-checked-btn');
        const generateRecipeBtn = document.getElementById('generate-recipe-btn'); // ΝΕΟ
        
        const itemModal = document.getElementById('item-modal');
        const itemForm = document.getElementById('item-form');
        const itemListIdSelect = document.getElementById('item-list-id');
        const cancelItemBtn = document.getElementById('cancel-item-btn');

        const manageListsBtn = document.getElementById('manage-lists-btn');
        const listModal = document.getElementById('list-modal');
        const listForm = document.getElementById('list-form');
        const listsDisplay = document.getElementById('lists-display');
        const closeListModalBtn = document.getElementById('close-list-modal-btn');
        
        const recipeModal = document.getElementById('recipe-modal'); // ΝΕΟ
        const recipeTitle = document.getElementById('recipe-title'); // ΝΕΟ
        const recipeDescription = document.getElementById('recipe-description'); // ΝΕΟ
        const recipeIngredients = document.getElementById('recipe-ingredients'); // ΝΕΟ
        const recipeInstructions = document.getElementById('recipe-instructions'); // ΝΕΟ
        const closeRecipeModalBtn = document.getElementById('close-recipe-modal-btn'); // ΝΕΟ
        
        // 2. Custom Alert Function (Non-blocking)
        function showCustomAlert(message, type = 'info') {
            const existingAlert = document.getElementById('custom-alert');
            if (existingAlert) existingAlert.remove();

            const alertBox = document.createElement('div');
            alertBox.id = 'custom-alert';
            
            let baseClasses = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-3 px-6 rounded-full text-white font-medium text-sm shadow-xl transition-all duration-300 ease-out z-[100]';
            let typeClasses;

            if (type === 'success') {
                typeClasses = 'bg-green-500';
            } else if (type === 'error') {
                typeClasses = 'bg-red-500';
            } else {
                typeClasses = 'bg-blue-500';
            }

            alertBox.className = `${baseClasses} ${typeClasses} opacity-0 scale-95`;
            alertBox.textContent = message;
            document.body.appendChild(alertBox);

            // Εμφάνιση
            setTimeout(() => {
                alertBox.classList.remove('opacity-0', 'scale-95');
            }, 50);

            // Απόκρυψη
            setTimeout(() => {
                alertBox.classList.add('opacity-0', 'scale-95');
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000);
        }

        // 3. Χειρισμός API Call (με exponential backoff)
        async function handleGeminiApiCall(payload, maxRetries = 3) {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        try {
                            // Επιστροφή του parsed JSON αν υπάρχει
                            return JSON.parse(candidate.content.parts[0].text);
                        } catch (e) {
                            console.error("Failed to parse JSON response:", e);
                            throw new Error("Invalid structured response from AI.");
                        }
                    } else {
                        throw new Error("AI response was empty or malformed.");
                    }

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API call failed after all retries:", error);
                        throw error;
                    }
                }
            }
            throw new Error("Gemini API call failed after maximum retries.");
        }


        // 4. Λειτουργίες Modal
        function openItemModal(item) {
            const titleElement = document.getElementById('item-modal-title');
            const saveButton = document.getElementById('save-item-btn');

            if (item) {
                titleElement.textContent = 'Επεξεργασία Είδους';
                saveButton.textContent = 'Ενημέρωση';
                document.getElementById('item-id-input').value = item.id;
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-list-id').value = item.listId;
            } else {
                titleElement.textContent = 'Προσθήκη Είδους';
                saveButton.textContent = 'Αποθήκευση';
                document.getElementById('item-id-input').value = '';
                document.getElementById('item-name').value = '';
                // Θέτει την default λίστα
                document.getElementById('item-list-id').value = listSelector.value !== 'all' ? listSelector.value : (lists.length > 0 ? lists[0].id : '');
            }
            itemModal.classList.remove('hidden');
        }

        function closeItemModal() {
            itemModal.classList.add('hidden');
            itemForm.reset();
        }
        
        function openListModal() {
            renderListsInModal();
            listModal.classList.remove('hidden');
        }

        function closeListModal() {
            listModal.classList.add('hidden');
            listForm.reset();
        }
        
        function openRecipeModal(recipe) { // ΝΕΟ
            recipeTitle.textContent = recipe.recipeName;
            recipeDescription.textContent = recipe.description;
            
            recipeIngredients.innerHTML = recipe.ingredients.map(ing => `<li>${ing}</li>`).join('');
            recipeInstructions.innerHTML = recipe.instructions.map(inst => `<li>${inst}</li>`).join('');
            
            recipeModal.classList.remove('hidden');
        }

        function closeRecipeModal() { // ΝΕΟ
            recipeModal.classList.add('hidden');
        }


        // 5. Λειτουργίες Firestore - Είδη
        async function toggleItemChecked(itemId, isChecked) {
            try {
                const itemRef = doc(db, ITEMS_COLLECTION_PATH, itemId);
                await updateDoc(itemRef, {
                    checked: !isChecked
                });
            } catch (error) {
                console.error("Error toggling item:", error);
                showCustomAlert("Σφάλμα στην ενημέρωση του είδους.", 'error');
            }
        }

        async function handleItemFormSubmit(event) {
            event.preventDefault();
            
            if (!isAuthReady || !userId) {
                 showCustomAlert("Η σύνδεση δεν έχει ολοκληρωθεί. Προσπαθήστε ξανά.", 'error');
                 return;
            }

            const itemId = document.getElementById('item-id-input').value;
            const name = document.getElementById('item-name').value.trim();
            const listId = document.getElementById('item-list-id').value;

            if (name === "" || listId === "") {
                showCustomAlert("Συμπληρώστε όλα τα πεδία.", 'error');
                return;
            }

            try {
                if (itemId) {
                    // Επεξεργασία
                    const itemRef = doc(db, ITEMS_COLLECTION_PATH, itemId);
                    await updateDoc(itemRef, { name, listId, timestamp: serverTimestamp() });
                    showCustomAlert("Το είδος ενημερώθηκε επιτυχώς!", 'success');
                } else {
                    // Προσθήκη
                    await addDoc(collection(db, ITEMS_COLLECTION_PATH), {
                        name,
                        listId,
                        checked: false,
                        userId: userId, // Ο χρήστης που το δημιούργησε
                        timestamp: serverTimestamp()
                    });
                    showCustomAlert("Το είδος προστέθηκε επιτυχώς!", 'success');
                }
                closeItemModal();
            } catch (error) {
                console.error("Error saving item:", error);
                showCustomAlert("Σφάλμα στην αποθήκευση του είδους.", 'error');
            }
        }
        
        async function deleteItem(itemId) {
            if (!confirm("Είστε σίγουροι ότι θέλετε να διαγράψετε αυτό το είδος;")) return;

            try {
                await deleteDoc(doc(db, ITEMS_COLLECTION_PATH, itemId));
                showCustomAlert("Το είδος διαγράφηκε!", 'success');
            } catch (error) {
                console.error("Error deleting item:", error);
                showCustomAlert("Σφάλμα κατά τη διαγραφή.", 'error');
            }
        }
        
        async function deleteCheckedItems() {
            const checkedItems = items.filter(item => item.checked);
            if (checkedItems.length === 0) {
                showCustomAlert("Δεν υπάρχουν επιλεγμένα είδη προς διαγραφή.", 'info');
                return;
            }

            if (!confirm(`Είστε σίγουροι ότι θέλετε να διαγράψετε ${checkedItems.length} επιλεγμένα είδη;`)) return;

            const batch = writeBatch(db);
            checkedItems.forEach(item => {
                const itemRef = doc(db, ITEMS_COLLECTION_PATH, item.id);
                batch.delete(itemRef);
            });

            try {
                await batch.commit();
                showCustomAlert(`Διαγράφηκαν ${checkedItems.length} είδη!`, 'success');
            } catch (error) {
                console.error("Error deleting checked items:", error);
                showCustomAlert("Σφάλμα κατά τη μαζική διαγραφή.", 'error');
            }
        }


        // 6. Λειτουργίες Firestore - Λίστες
        async function handleListFormSubmit(event) {
            event.preventDefault();
            
            if (!isAuthReady || !userId) {
                 showCustomAlert("Η σύνδεση δεν έχει ολοκληρωθεί.", 'error');
                 return;
            }

            const name = document.getElementById('list-name-input').value.trim();
            if (name === "") return;

            try {
                await addDoc(collection(db, LISTS_COLLECTION_PATH), {
                    name,
                    userId: userId, 
                    timestamp: serverTimestamp()
                });
                showCustomAlert("Η λίστα προστέθηκε!", 'success');
                listForm.reset();
            } catch (error) {
                console.error("Error adding list:", error);
                showCustomAlert("Σφάλμα κατά την προσθήκη λίστας.", 'error');
            }
        }
        
        async function deleteList(listId) {
            if (lists.length === 1) {
                showCustomAlert("Δεν μπορείτε να διαγράψετε την τελευταία λίστα.", 'error');
                return;
            }
            if (!confirm("Προσοχή! Με τη διαγραφή της λίστας, θα διαγραφούν και ΟΛΑ τα είδη που ανήκουν σε αυτήν. Είστε σίγουροι;")) return;

            const batch = writeBatch(db);
            try {
                // 1. Διαγραφή των ειδών που ανήκουν σε αυτή τη λίστα
                const itemsQuery = query(collection(db, ITEMS_COLLECTION_PATH), where("listId", "==", listId));
                const itemsSnapshot = await getDocs(itemsQuery);
                itemsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 2. Διαγραφή της ίδιας της λίστας
                const listRef = doc(db, LISTS_COLLECTION_PATH, listId);
                batch.delete(listRef);

                await batch.commit();
                showCustomAlert("Η λίστα και τα είδη της διαγράφηκαν!", 'success');
                
                // Ενημέρωση φίλτρου αν διαγράφηκε η τρέχουσα λίστα
                if (currentListFilter === listId) {
                    currentListFilter = 'all';
                    listSelector.value = 'all';
                }

            } catch (error) {
                console.error("Error deleting list and items:", error);
                showCustomAlert("Σφάλμα κατά τη διαγραφή της λίστας.", 'error');
            }
        }

        // 7. Λειτουργίες Render
        function renderListsInModal() {
            listsDisplay.innerHTML = '';
            
            if (lists.length === 0) {
                 listsDisplay.innerHTML = '<p class="text-gray-500 italic p-2">Δεν υπάρχουν λίστες.</p>';
                 return;
            }

            lists.forEach(list => {
                const listDiv = document.createElement('div');
                listDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg border border-gray-200';
                
                const itemName = document.createElement('span');
                itemName.textContent = list.name;
                itemName.className = 'font-medium text-gray-800';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Διαγραφή';
                deleteBtn.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold hover:bg-red-200 transition duration-150';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteList(list.id);
                });

                listDiv.appendChild(itemName);
                listDiv.appendChild(deleteBtn);
                listsDisplay.appendChild(listDiv);
            });
        }
        
        function updateListSelectors() {
            // Ενημέρωση του φίλτρου λίστας (listSelector)
            const oldFilterValue = listSelector.value;
            listSelector.innerHTML = '<option value="all">Όλες οι λίστες</option>';
            itemListIdSelect.innerHTML = '';

            lists.forEach(list => {
                const optionFilter = document.createElement('option');
                optionFilter.value = list.id;
                optionFilter.textContent = list.name;
                listSelector.appendChild(optionFilter);

                const optionModal = optionFilter.cloneNode(true);
                itemListIdSelect.appendChild(optionModal);
            });
            
            // Διατήρηση της επιλεγμένης τιμής
            if (lists.some(l => l.id === oldFilterValue)) {
                listSelector.value = oldFilterValue;
                currentListFilter = oldFilterValue;
            } else {
                 listSelector.value = 'all';
                 currentListFilter = 'all';
            }
        }
        
        function renderItems() {
            const filteredItems = items.filter(item => 
                currentListFilter === 'all' || item.listId === currentListFilter
            );

            itemsContainer.innerHTML = '';
            
            if (filteredItems.length === 0) {
                emptyListMessage.classList.remove('hidden');
                return;
            }
            emptyListMessage.classList.add('hidden');

            filteredItems.sort((a, b) => {
                if (a.checked && !b.checked) return 1;
                if (!a.checked && b.checked) return -1;
                return (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0);
            }).forEach(item => {
                const listName = lists.find(l => l.id === item.listId)?.name || 'Άγνωστη Λίστα';

                const itemDiv = document.createElement('div');
                itemDiv.className = `flex items-center justify-between p-4 rounded-xl shadow-sm cursor-pointer transition duration-200 ${item.checked ? 'bg-green-50/70 border-l-4 border-green-500 line-through text-gray-500' : 'bg-white hover:bg-gray-50 border-l-4 border-primary-500'}`;
                
                const leftSection = document.createElement('div');
                leftSection.className = 'flex items-center space-x-3 flex-1 min-w-0';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.checked;
                checkbox.className = 'w-5 h-5 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500';
                checkbox.addEventListener('change', () => toggleItemChecked(item.id, item.checked));

                const textContent = document.createElement('div');
                textContent.className = 'min-w-0 flex-1';

                const nameSpan = document.createElement('span');
                nameSpan.textContent = item.name;
                nameSpan.className = 'block font-medium truncate';
                
                const listTag = document.createElement('span');
                listTag.textContent = listName;
                listTag.className = 'block text-xs text-gray-400 mt-0.5';

                textContent.appendChild(nameSpan);
                textContent.appendChild(listTag);
                leftSection.appendChild(checkbox);
                leftSection.appendChild(textContent);
                
                const actionsSection = document.createElement('div');
                actionsSection.className = 'flex space-x-2 ml-4';

                const editBtn = document.createElement('button');
                editBtn.innerHTML = `
                    <svg class="w-5 h-5 text-blue-500 hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-7 7l-2 2"></path></svg>
                `;
                editBtn.title = 'Επεξεργασία';
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openItemModal(item);
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `
                    <svg class="w-5 h-5 text-red-500 hover:text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                `;
                deleteBtn.title = 'Διαγραφή';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteItem(item.id);
                });

                actionsSection.appendChild(editBtn);
                actionsSection.appendChild(deleteBtn);
                
                itemDiv.appendChild(leftSection);
                itemDiv.appendChild(actionsSection);

                itemsContainer.appendChild(itemDiv);
            });
        }
        
        // 8. ΝΕΑ Λειτουργία: Προτάσεις Συνταγών με Gemini LLM
        async function generateRecipe() {
            const ingredients = items.filter(item => !item.checked).map(item => item.name);

            if (ingredients.length === 0) {
                showCustomAlert("Η λίστα αγορών σας είναι άδεια! Δεν μπορώ να προτείνω συνταγή.", 'error');
                return;
            }

            const ingredientList = ingredients.join(', ');
            const prompt = `Based on these ${ingredients.length} specific ingredients you need to buy: "${ingredientList}", suggest a simple, delicious recipe that uses most of them. The description should be one short, appetizing paragraph in Greek. The recipe name should also be in Greek.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "You are a world-class chef and food blogger. Respond only with a complete JSON object according to the provided schema, based on the user's ingredients. Do not include any text outside the JSON." }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "recipeName": { "type": "STRING", "description": "The name of the recipe in Greek." },
                            "description": { "type": "STRING", "description": "A short, appetizing single-paragraph description in Greek." },
                            "ingredients": {
                                "type": "ARRAY",
                                "description": "List of all ingredients required (including those from the user's list) in Greek.",
                                "items": { "type": "STRING" }
                            },
                            "instructions": {
                                "type": "ARRAY",
                                "description": "Step-by-step instructions for the recipe in Greek.",
                                "items": { "type": "STRING" }
                            }
                        },
                        "propertyOrdering": ["recipeName", "description", "ingredients", "instructions"]
                    }
                }
            };
            
            showCustomAlert("Ετοιμάζω μια συνταγή από τα είδη της λίστας σας...", 'info');
            generateRecipeBtn.disabled = true;

            try {
                const recipe = await handleGeminiApiCall(payload);
                if (recipe && recipe.recipeName) {
                    openRecipeModal(recipe);
                } else {
                    throw new Error("Received empty or invalid recipe structure.");
                }
            } catch (error) {
                console.error("Recipe generation failed:", error);
                showCustomAlert("Αποτυχία πρότασης συνταγής. Δοκιμάστε ξανά.", 'error');
            } finally {
                generateRecipeBtn.disabled = false;
            }
        }


        // 9. Εκκίνηση Firebase & Listeners
        function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Για debugging
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatus.textContent = `Συνδεδεμένος ως: ${userId}`;
                    } else {
                        // Ανώνυμη σύνδεση σε περίπτωση που δεν υπάρχει token
                        userId = crypto.randomUUID();
                        authStatus.textContent = `Προσωρινός χρήστης: ${userId}`;
                        await signInAnonymously(auth);
                    }
                    isAuthReady = true;
                    startListeners(); // Ξεκινά τους listeners μόνο αφού γίνει authentication
                });

                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.error("Custom token sign-in failed:", e);
                    });
                } else {
                    signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showCustomAlert("Σφάλμα στην αρχικοποίηση της βάσης δεδομένων.", 'error');
            }
        }
        
        function startListeners() {
            if (!db || !isAuthReady) return;

            // Listener για Λίστες
            const listsQuery = query(collection(db, LISTS_COLLECTION_PATH));
            onSnapshot(listsQuery, (snapshot) => {
                lists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Δημιουργία default λίστας αν δεν υπάρχει καμία
                if (lists.length === 0) {
                    addDoc(collection(db, LISTS_COLLECTION_PATH), {
                        name: "Γενικά Ψώνια",
                        userId: userId, 
                        timestamp: serverTimestamp()
                    }).then(() => {
                        console.log("Default list created.");
                    }).catch(e => console.error("Could not create default list:", e));
                } else {
                    updateListSelectors();
                    renderItems(); // Ενημέρωση ελέγχου για το φίλτρο
                }
            }, (error) => {
                console.error("Error listening to lists:", error);
            });
            
            // Listener για Είδη
            const itemsQuery = query(collection(db, ITEMS_COLLECTION_PATH));
            onSnapshot(itemsQuery, (snapshot) => {
                items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems();
            }, (error) => {
                console.error("Error listening to items:", error);
            });
        }


        // 10. Event Listeners
        window.addEventListener('load', initializeFirebase);
        
        listSelector.addEventListener('change', () => {
            currentListFilter = listSelector.value;
            renderItems();
        });
        
        deleteCheckedBtn.addEventListener('click', deleteCheckedItems);
        generateRecipeBtn.addEventListener('click', generateRecipe); // ΝΕΟ Listener
        
        addItemFab.addEventListener('click', () => openItemModal(null));
        itemForm.addEventListener('submit', handleItemFormSubmit);
        cancelItemBtn.addEventListener('click', closeItemModal);
        
        manageListsBtn.addEventListener('click', openListModal);
        listForm.addEventListener('submit', handleListFormSubmit);
        closeListModalBtn.addEventListener('click', closeListModal);
        
        closeRecipeModalBtn.addEventListener('click', closeRecipeModal); // ΝΕΟ Listener
        
        
    </script>
</body>
</html>
